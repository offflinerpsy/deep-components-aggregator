---
applyTo: '**'
---
# Project: Deep Components Aggregator — Copilot Instructions (GPT-5 / GPT-5-Codex)

## Mission & Truth
- Мы делаем агрегатор электронных компонентов с **живым поиском** и **кэш-слоем**.
- Источники контента (описания/спеки/изображения/доки): DigiKey, Mouser, Farnell, TME.
- Цены/склады агрегируются через OEMstrade. **Пользователь видит только регион/цену/наличие**; ссылки на дилеров — **только в админке**.
- Любые найденные позиции пишем в кэш. Ручные («мертвые») карточки также участвуют в поиске.
- Нормализация **RU→EN** обязательна: “транзистор” должно находить релевантные “transistor”.
- Гео-ограничения обходятся **прокси-политикой** (WARP). В node-коде HTTP идёт через **Undici ProxyAgent** с `setGlobalDispatcher` и корректным `NO_PROXY` для локалхоста.

## Architecture & Boundaries
- **Backend** (Express) — источник данных и прокси-политики; секреты/ключи — **только через ENV**.
- **Frontend** (Next.js App Router) — визуальный слой **v0-шаблона**. **Сетку/лейаут НЕ менять**. Допустимы только правки токенов/утилити-классов для отступов.
- Общение фронта с бэком — **строго через Next.js rewrites** по `/api/*` (URL-прокси; CORS и секреты не выносим на клиент).
- Live-поиск — **SSE**: `Content-Type: text/event-stream; charset=utf-8`; события разделяются **двойным \n**; heartbeat комментариями `: ping`. На реверсе поток не буферить: ответ должен включать `X-Accel-Buffering: no` (или точечный `proxy_buffering off` в nginx).

## Operative Rules (no guesswork)
1) **Всегда начинать с разведки (R)**:
   - Прочитать в репозитории: `API-CONTRACT.md`, `docs/_artifacts/**`, `README*`, `*REPORT*.md`.
   - Зафиксировать факты в новых артефактах (curl-дампы, headers, SSE-фрагменты) прежде чем писать код.
2) **Потом реализация (I)**:
   - Фронт: `/` → сабмит на `/results?q=…`; `/results` тянет **через /api/** (rewrites) cache-эндпоинт и/или live-SSE; `/product/[mpn]` наполняется данными (Specs/Offers/Docs) без слома сетки; Offers — пагинация если >50.
   - Админ-логика (цены/наценка/ссылки дилеров) — **не выводить** пользователю.
3) **Затем доказательства (P)**:
   - В `docs/_artifacts/<block>/` приложить: `rewrites-proof.md` (сравнение заголовков «напрямую vs через фронт»), `api-captures/*.txt`, `sse-proof/*` (headers + первые 100 строк), `ui-smoke-results.md` (таблица PASS + скрины для `/`, `/results`, `/product` в 3 брейкпоинтах).

## Coding Standard (hard rules)
- **Никаких try/catch** в новом коде — только guard-ветки/ранние возвраты.
- **Conventional Commits**; EditorConfig/ESLint соблюдаем; детерминированные сборки.
- **Не изменять** макет/сетку v0; компоненты — только переиспользовать; стили — через существующие токены.
- Все вызовы с фронта — **только** `/api/*` (rewrites). Прямых URL бэка, CORS-костылей, лейкинга ключей — **запрещено**.
- SSE: формат и антибуферизация — **обязательный контракт**; если поток «склеивается» — это баг в прокси или заголовках, чинить.
- Прокси: в node устанавливать **один** глобальный dispatcher (`ProxyAgent`) и корректный `NO_PROXY=127.0.0.1,localhost`.
- Артефакты — обязательны в каждом PR (R→I→P).

## PR Definition of Done
- `/results` и `/product` рендерят **реальные** данные без изменения сетки v0.
- Все клиентские вызовы идут через `/api/*` (rewrites подтверждён артефактом).
- SSE соответствует MDN/WHATWG (двойной \n, heartbeat) и не буферится на реверсе (доказано заголовком/конфигом).
- Пустые состояния/ошибки отображаются «мягко» (бейджи/подсказки), UX устойчив к неполным данным.
- В PR приложены: `rewrites-proof.md`, `api-captures/*`, `sse-proof/*`, `ui-smoke-results.md`.

## Model Use (Copilot Chat)
- **Default:** GPT-5 (reasoning, длинные задачи).
- **Focused coding:** GPT-5-Codex при heavy-кодогенерации/редактировании множества файлов.
- Если в клиенте включён **auto-model selection** — не отключать без причины; при ручном выборе модели придерживаться правил выше.
