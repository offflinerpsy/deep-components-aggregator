name: ci
on:
  push: { branches: [ main, feature/** ] }
  pull_request: { branches: [ main ] }
jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix: { os: [ubuntu-latest], node: [20.x] }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: ${{ matrix.node }}, cache: 'npm' }
      - run: npm ci --ignore-scripts
      - run: npx playwright install --with-deps
      - run: node server.js & echo $! > .server.pid
      - run: npx playwright test --reporter=line
      - if: always()
        run: |
          kill $(cat .server.pid) || true
          mkdir -p artifacts && cp -r playwright-report artifacts/ || true
      - uses: actions/upload-artifact@v4
        if: always()
        with: { name: pw-report, path: artifacts }
