# DATA-FLOW.md — Потоки данных

**Обновлено**: 21 декабря 2025

---

## 💰 ОТКУДА БЕРУТСЯ ЦЕНЫ

### Источники (API провайдеров):

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Mouser    │     │   DigiKey   │     │     TME     │     │   Farnell   │
│  API v1     │     │  API v4     │     │   API       │     │    API      │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                   │
       │ PriceBreaks[]     │ StandardPricing[] │ PriceList[]       │ prices[]
       │ USD/EUR/GBP       │ USD               │ EUR/PLN           │ GBP/EUR
       │                   │                   │                   │
       └───────────────────┴───────────────────┴───────────────────┘
                                    │
                                    ▼
                          ┌─────────────────┐
                          │  Нормализация   │
                          │  normalize.mjs  │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ Конвертация     │
                          │ ЦБ РФ → RUB     │
                          │ src/currency/   │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │   Наценка       │
                          │ markup.mjs      │
                          │ % из settings   │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ min_price_rub   │
                          │ (финальная      │
                          │  цена для       │
                          │  пользователя)  │
                          └─────────────────┘
```

### Формула наценки:
```javascript
finalPrice = originalPrice * (1 + markup_percentage / 100)
// markup_percentage берётся из таблицы settings
```

### Конвертация валют:
```javascript
// Источник: ЦБ РФ XML API
// Кэш: data/rates.json (TTL 12 часов)
// Fallback: USD=90, EUR=100

const rub = amount * rates[currency];
```

---

## 🔍 FLOW: Поиск товаров

```
┌──────────────────────────────────────────────────────────────────┐
│                        ПОЛЬЗОВАТЕЛЬ                               │
│                  Вводит: "LM317" в поиск                         │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                     FRONTEND (Next.js)                           │
│  /results?q=LM317                                                │
│  ResultsClient.tsx → fetch('/api/search?q=LM317')                │
└─────────────────────────────┬────────────────────────────────────┘
                              │ HTTP GET
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                     BACKEND (Express:9201)                        │
│  server.js:684 → processSearchQuery(q)                           │
│                                                                   │
│  1. Нормализация запроса (RU→EN, транслитерация)                 │
│  2. Проверка кэша (searches + search_rows)                       │
│  3. Если кэш свежий → return cached                              │
└─────────────────────────────┬────────────────────────────────────┘
                              │ Кэш пустой/старый
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                 PROVIDER ORCHESTRATOR                             │
│  src/search/providerOrchestrator.mjs                             │
│                                                                   │
│  PQueue (concurrency=4) параллельно вызывает:                    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                 │
│  │ Mouser  │ │ DigiKey │ │   TME   │ │ Farnell │                 │
│  │  API    │ │  API    │ │   API   │ │   API   │                 │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘                 │
│       │           │           │           │                       │
│       └───────────┴───────────┴───────────┘                       │
│                       │                                           │
│                       ▼                                           │
│              Нормализация каждого результата                      │
│              normMouser / normDigiKey / normTME / normFarnell     │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                    POST-PROCESSING                                │
│                                                                   │
│  1. dedupeRows() — удаление дубликатов по MPN                    │
│  2. rankRows(query) — ранжирование по релевантности              │
│  3. applyMarkupToProducts() — применение наценки                 │
│  4. Кэширование в SQLite (TTL 7 дней)                            │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                      RESPONSE                                     │
│  {                                                                │
│    ok: true,                                                      │
│    q: "LM317",                                                    │
│    rows: [{mpn, manufacturer, min_price_rub, stock, ...}],       │
│    meta: { total, elapsed, providers: ['mouser','digikey',...] } │
│  }                                                                │
└──────────────────────────────────────────────────────────────────┘
```

---

## 📦 FLOW: Карточка товара

```
┌──────────────────────────────────────────────────────────────────┐
│                        ПОЛЬЗОВАТЕЛЬ                               │
│                  Открывает: /product/LM317T                       │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                     FRONTEND (Next.js)                           │
│  app/product/[mpn]/page.tsx                                      │
│  fetch('/api/product?mpn=LM317T')                                │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                     BACKEND (server.js:813)                       │
│                                                                   │
│  1. getManualProduct(mpn) — проверка ручных товаров              │
│     → Если есть → return manual product                          │
│                                                                   │
│  2. readCachedProduct(db, mpn, TTL=30 days)                      │
│     → Если свежий кэш → return cached                            │
│                                                                   │
│  3. Promise.allSettled([...]) — параллельные запросы             │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                   PARALLEL API CALLS                              │
│                                                                   │
│  ┌─────────────────┐    ┌─────────────────┐                      │
│  │ mouserSearch    │    │ digikeyGet      │                      │
│  │ ByPartNumber    │    │ Product         │                      │
│  └────────┬────────┘    └────────┬────────┘                      │
│           │                      │                                │
│  ┌────────┴────────┐    ┌────────┴────────┐                      │
│  │ tmeGetProduct   │    │ farnellByMPN    │                      │
│  └────────┬────────┘    └────────┬────────┘                      │
│           │                      │                                │
│           └──────────┬───────────┘                                │
│                      │                                            │
│                      ▼                                            │
│            mergeProductData()                                     │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                    MERGE PRIORITIES                               │
│                                                                   │
│  Картинки:  Mouser > DigiKey > TME > Farnell                     │
│  Спеки:     TME > Farnell > DigiKey > Mouser                     │
│  Датащиты:  Все источники (объединяются)                         │
│  Цены:      Все источники (показываются все варианты)            │
│  Stock:     MAX из всех источников                               │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  cacheProduct(db, mpn, product)  // Кэш на 30 дней               │
│                                                                   │
│  RESPONSE:                                                        │
│  {                                                                │
│    ok: true,                                                      │
│    product: {                                                     │
│      mpn, manufacturer, title, description,                       │
│      images[], datasheets[], technical_specs{},                  │
│      pricing[], availability{}, regions[]                        │
│    },                                                             │
│    meta: { cached: false, sources: ['mouser','digikey',...] }    │
│  }                                                                │
└──────────────────────────────────────────────────────────────────┘
```

---

## 💡 FLOW: Автокомплит

```
┌──────────────────────────────────────────────────────────────────┐
│  Пользователь вводит: "LM3" (debounce 300ms)                     │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  AutocompleteSearch.tsx → fetch('/api/autocomplete?q=LM3')       │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  server.js:585 → autocompleteOrchestrator.mjs                    │
│                                                                   │
│  1. Проверка SQLite кэша (autocomplete_cache, TTL=1h)            │
│     → hit → return cached                                         │
│                                                                   │
│  2. Параллельные suggest запросы:                                │
│     ├── mouserSuggest(q)                                         │
│     ├── farnellSuggest(q)                                        │
│     ├── tmeSuggest(q)                                            │
│     └── digikeySuggest(q)  // Тяжёлый, может пропускаться        │
│                                                                   │
│  3. Дедупликация + сортировка                                    │
│  4. Кэширование результата                                       │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  RESPONSE:                                                        │
│  {                                                                │
│    suggestions: [                                                 │
│      { mpn: 'LM317T', manufacturer: 'TI', source: 'mouser' },   │
│      { mpn: 'LM358', manufacturer: 'TI', source: 'digikey' },   │
│      ...                                                          │
│    ],                                                             │
│    meta: { q, cached, latencyMs, providersHit }                  │
│  }                                                                │
└──────────────────────────────────────────────────────────────────┘
```

---

## 🌐 FLOW: Витрина (главная страница)

```
┌──────────────────────────────────────────────────────────────────┐
│  Пользователь открывает: /                                        │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  api/vitrine.mjs → Cache-Only Product Browsing                   │
│                                                                   │
│  Источники данных:                                               │
│  1. vitrine_pins — закреплённые товары                           │
│  2. searches + search_rows — кэш предыдущих поисков              │
│  3. products_fts — FTS5 индекс для быстрого поиска               │
│                                                                   │
│  ⚠️ НЕ делает внешних API запросов!                              │
│  Показывает только закэшированные данные.                        │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  RESPONSE:                                                        │
│  {                                                                │
│    ok: true,                                                      │
│    items: [{ mpn, manufacturer, min_price_rub, image_url }...], │
│    meta: { total, sections }                                     │
│  }                                                                │
└──────────────────────────────────────────────────────────────────┘
```

---

## 🗂️ FLOW: Каталог категорий

```
┌──────────────────────────────────────────────────────────────────┐
│  Пользователь: /catalog/semiconductors/transistors              │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  api/catalog.mjs                                                  │
│                                                                   │
│  Источник: таблица catalog_categories (1193 категории)           │
│  Импортировано из DigiKey category tree                          │
│                                                                   │
│  Структура:                                                       │
│  - id, name, slug                                                 │
│  - parent_id (иерархия)                                          │
│  - is_leaf (конечная категория → редирект на поиск)              │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  Если is_leaf=true:                                               │
│    → Redirect на /results?q={category_name}                      │
│                                                                   │
│  Если is_leaf=false:                                              │
│    → Показать подкатегории                                        │
└──────────────────────────────────────────────────────────────────┘
```

---

## 📝 ВАЖНО: Что НЕ является источником данных

| ❌ НЕ источник | Объяснение |
|---------------|------------|
| **OEMstrade API** | Не существует! Старая документация врала |
| **LCSC** | Код есть, но не подключен |
| **Octopart** | Код есть, но не подключен |
| **ChipDip/Promelec** | Были планы, не реализовано |

### Реальные источники:
✅ Mouser API  
✅ DigiKey API  
✅ TME API  
✅ Farnell API  
✅ ЦБ РФ (курсы)  
✅ Manual Products (SQLite)
