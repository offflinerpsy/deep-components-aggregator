# План работ: SCOUT-V1

## Цели за один проход:
1.  **Подтянуть список доноров** (агрегаторы + RU-магазины) и проверить их доступность (коды 200/403/5xx, анализ `robots.txt`).
2.  **Сделать микро-краулер** для навигации: `поиск` → `выдача` → `карточка`. Сохранить RAW HTML снапшоты для каждого шага.
3.  **Вытащить канон-поля**: `mpn`, `brand`, `title`, `description_short`, `image`, `pdfs[]`, `offers[]`, где `offers`=[{`dealer`, `url`, `price`, `currency`, `availability`, `region`}].
4.  **Сохранить репорт** по каждому донору + общий `Markdown-отчёт`.

## ЖЁСТКИЕ ПРАВИЛА
- **Новый код без `try/catch`**. Ошибки обрабатываем через ветвления (`if (!ok) return …`) и коды выхода скриптов.
- **Ничего не ломаем в существующих модулях**; новые файлы — в `src/scout/**` и `scripts/**`.
- **Стоп-условие**: на любой фатальной ошибке — останавливаемся и пишем краткий лог в `_scout/last/FAIL.txt`.
- **Прокси** включать только если заданы `HTTP_PROXY`/`HTTPS_PROXY`.
- **Скорость**: `concurrency=2`, `delay=1200–2500ms` между запросами к одному домену.

## 0) Подготовка репозитория
- [x] Ветка: `feat/scout-v1`
- [x] Зависимости: `undici`, `cheerio`, `fast-xml-parser`, `iconv-lite`
- [x] `package.json` тип: `"module"`

## 1) Кандидаты (список для первой волны)
- [x] Создать `src/scout/candidates.json` с 12 кандидатами.

## 2) Канон-схема и хранилище результатов
- [x] Создать `src/scout/schema.js` с функцией `canonItem`.
- [ ] Определить структуру папок для артефактов в `_scout/`.

## 3) Универсальные утилиты
- [ ] `src/scout/http.mjs`: `GET` c `undici` + прокси + декодирование `win1251`.
- [ ] `src/scout/parse-helpers.mjs`: Вспомогательные функции для парсинга (`text`, `abs`, `pickPrice` и т.д.).

## 4) Адаптеры доноров (по одному модулю на сайт)
- [ ] Создать папку `src/scout/providers/`.
- [ ] Сгенерировать файлы-заготовки для каждого адаптера с функциями `search(q)` и `product(url)`.
- [ ] Реализовать базовую логику парсинга для 1-2 адаптеров (например, `promelec` и `efind`).

## 5) Раннер «скаут»
- [ ] Создать `scripts/scout.mjs`.
- [ ] Реализовать логику чтения кандидатов, запуска адаптеров, сохранения артефактов и генерации `REPORT.md`.

## 6) Прокси и Playwright
- [ ] Убедиться, что `src/net/proxy.mjs` (если существует) используется корректно.
- [ ] Интегрировать Playwright для адаптеров с меткой `{ "js": true }`.

## 7) Команды запуска
- [ ] Определить финальную команду в `package.json` (например, `npm run scout`).

## 8) Артефакты и отчётность
- [ ] Убедиться, что все артефакты (`REPORT.md`, `json/`, `raw/`) создаются корректно.

## 9) Критерии готовности (Definition of Done)
- [ ] Не менее 8 из 12 доноров дают валидные объекты для минимум 6 из 10 тест-запросов.
- [ ] В отчёте заполнены `mpn`/`brand`, извлечены цены (если есть), собраны PDF.
- [ ] Блокировки/капчи отражены как `status: blocked`.
- [ ] Прокси используется, если задан `ENV`.
- [ ] В новом коде нет `try/catch`.

