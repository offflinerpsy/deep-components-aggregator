# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì –ò–°–ü–†–ê–í–õ–ï–ù + –õ–û–ì–ò–ö–ê AUTO-LIVE SEARCH

**–î–∞—Ç–∞**: 12 –æ–∫—Ç—è–±—Ä—è 2025, 15:50 UTC  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ì–û–¢–û–í–û –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ**

---

## üêõ –ü–†–û–ë–õ–ï–ú–´ –ù–ê–ô–î–ï–ù–´

### 1. React Hooks Order Violation (**CRITICAL**)

**–û—à–∏–±–∫–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**:
```
Error: Rendered more hooks than during the previous render.
Source: components/ResultsClient.tsx (62:13)
```

**Root Cause**:

```typescript
// ‚ùå –ë–´–õ–û (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
useEffect(() => {
  setTimeout(() => setIsLoading(false), 800)
}, [])

if (isLoading) return <PageLoader />  // ‚ùå –†–ê–ù–ù–ò–ô –í–û–ó–í–†–ê–¢ –ü–û–°–õ–ï –•–£–ö–ê!

useEffect(() => {  // ‚ùå –ï–©–Å –û–î–ò–ù –•–£–ö –ü–û–°–õ–ï –£–°–õ–û–í–ò–Ø!
  if (mode !== 'live' || !q) return
  // ... SSE logic
}, [mode, q])
```

**–ü—Ä–æ–±–ª–µ–º–∞**: React —Ç—Ä–µ–±—É–µ—Ç —á—Ç–æ–±—ã **–≤—Å–µ —Ö—É–∫–∏** –≤—ã–∑—ã–≤–∞–ª–∏—Å—å –≤ **–æ–¥–∏–Ω–∞–∫–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ** –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ–Ω–¥–µ—Ä–µ. –†–∞–Ω–Ω–∏–π `return` –ø–æ—Å–ª–µ —Ö—É–∫–∞ –Ω–∞—Ä—É—à–∞–µ—Ç —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–æ.

**–†–µ—à–µ–Ω–∏–µ**:

```typescript
// ‚úÖ –°–¢–ê–õ–û (–ü–†–ê–í–ò–õ–¨–ù–û):
// –í–°–ï –•–£–ö–ò –°–ù–ê–ß–ê–õ–ê
useEffect(() => {
  setTimeout(() => setIsLoading(false), 800)
}, [])

useEffect(() => {
  if (mode !== 'live' || !q) return
  // ... SSE logic
}, [mode, q])

const grouped = useMemo(() => groupByMPN(rows), [rows])

// –†–ê–ù–ù–ò–ô –í–û–ó–í–†–ê–¢ –ü–û–°–õ–ï –í–°–ï–• –•–£–ö–û–í
if (isLoading) return <PageLoader />

return (
  <div>...</div>
)
```

---

### 2. –ü—É—Å—Ç–æ–π –∫—ç—à –ù–ï –∑–∞–ø—É—Å–∫–∞–ª live search (**CRITICAL**)

**–¢–≤–æ—è –ø—Ä–∞–≤–∫–∞**: "–∞ –Ω–∞—Ö—É—è –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–µ—à–µ? —É –Ω–∞—Å –ª–æ–≥–∏–∫–∞ –≤ —Ç–æ–º —á—Ç–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –∫–µ—à–µ —Ç–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–π –ª–∞–π–≤ –ø–æ–∏—Å–∫ –≤—Å–µ–≥–¥–∞!"

**–ü—Ä–æ–±–ª–µ–º–∞**:

```typescript
// ‚ùå –ë–´–õ–û:
const [mode, setMode] = useState<'cache' | 'live'>('cache')  // –í—Å–µ–≥–¥–∞ cache –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

// –ï—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç–æ–π ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" ‚Üí –ù–ï –ó–ê–ü–£–°–ö–ê–ï–¢ live search
```

**–†–µ—à–µ–Ω–∏–µ**:

```typescript
// ‚úÖ –°–¢–ê–õ–û:
const initialMode = (initial?.rows?.length === 0 && q) ? 'live' : 'cache'
const [mode, setMode] = useState<'cache' | 'live'>(initialMode)

// –ï—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç–æ–π ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–∂–∏–º 'live' ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç SSE
```

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –§–ê–ô–õ–´

### `/opt/deep-agg/v0-components-aggregator-page/components/ResultsClient.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:

1. **Auto-live search** –ø—Ä–∏ –ø—É—Å—Ç–æ–º –∫—ç—à–µ:
   ```typescript
   const initialMode = (initial?.rows?.length === 0 && q) ? 'live' : 'cache'
   ```

2. **React Hooks –ø–æ—Ä—è–¥–æ–∫**:
   - –í—Å–µ `useEffect` –∏ `useMemo` –ü–ï–†–ï–î –ª—é–±—ã–º `return`
   - –†–∞–Ω–Ω–∏–π –≤–æ–∑–≤—Ä–∞—Ç `if (isLoading) return <PageLoader />` –ü–û–°–õ–ï —Ö—É–∫–æ–≤

### `/opt/deep-agg/src/db/sql.mjs`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ** (—É–∂–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ —Ä–∞–Ω–µ–µ):

```javascript
// Escape FTS5 special characters
const escapedQuery = `"${query.replace(/"/g, '""')}"`;
db.prepare(sql).all(...weights, escapedQuery, limit);
```

---

## üß™ –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´ (–¢–ï–ü–ï–†–¨)

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ö—ç—à –∏–º–µ–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

1. SSR: `GET /results?q=FT232RL-REEL`
2. –ó–∞–ø—Ä–æ—Å –∫ `/api/vitrine/list?q=FT232RL-REEL`
3. FTS5 –ø–æ–∏—Å–∫ ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫—ç—à–µ
4. `initial.rows.length = 5` ‚Üí `initialMode = 'cache'`
5. –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ –∫—ç—à–∞
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ **Live (SSE)** –≤—Ä—É—á–Ω—É—é

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ö—ç—à –ø—É—Å—Ç–æ–π (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê)

1. SSR: `GET /results?q=NEW-COMPONENT-123`
2. –ó–∞–ø—Ä–æ—Å –∫ `/api/vitrine/list?q=NEW-COMPONENT-123`
3. FTS5 –ø–æ–∏—Å–∫ ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–∫—ç—à –ø—É—Å—Ç–æ–π)
4. `initial.rows.length = 0` ‚Üí **`initialMode = 'live'`** ‚úÖ
5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è live search** (SSE)
6. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ü–æ–∏—Å–∫..." + –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
7. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ SSE —Å–æ–±—ã—Ç–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –†—É—Å—Å–∫–∏–π –ø–æ–∏—Å–∫

1. SSR: `GET /results?q=—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä`
2. –ó–∞–ø—Ä–æ—Å –∫ `/api/vitrine/list?q=—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä`
3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: `—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä` ‚Üí `transistor` (RU‚ÜíEN)
4. FTS5 –ø–æ–∏—Å–∫ –ø–æ `"transistor"`
5. –ù–∞—Ö–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç
6. –ë–µ–π–¥–∂: "–ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ: transistor"

---

## üéØ –ö–†–ò–¢–ï–†–ò–ò –ü–†–ò–Å–ú–ö–ò

- [x] **React Hooks –ø–æ—Ä—è–¥–æ–∫** –∏—Å–ø—Ä–∞–≤–ª–µ–Ω
- [x] **Auto-live search** –ø—Ä–∏ –ø—É—Å—Ç–æ–º –∫—ç—à–µ
- [x] **FTS5 escaping** –¥–ª—è –¥–µ—Ñ–∏—Å–æ–≤ (`RS1G-13-F`)
- [x] **–†—É—Å—Å–∫–∏–π –ø–æ–∏—Å–∫** –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è (`—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä` ‚Üí `transistor`)
- [ ] **Browser test**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ

---

## üöÄ –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ü–†–û–í–ï–†–ö–ò

### 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Next.js (–ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

```bash
pkill -9 -f 'next-server'
cd /opt/deep-agg/v0-components-aggregator-page
PORT=3000 npm run dev
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

```bash
curl -s 'http://localhost:3000/' | grep "Deep Components Aggregator"
# –û–∂–∏–¥–∞–µ–º: "Deep Components Aggregator"
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –≤–∏—Ç—Ä–∏–Ω—ã

```bash
curl -s 'http://localhost:3000/api/vitrine/list?limit=3' | jq '.ok, (.rows | length)'
# –û–∂–∏–¥–∞–µ–º: true, 3
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å —Å –¥–µ—Ñ–∏—Å–æ–º

```bash
curl -s 'http://127.0.0.1:9201/api/vitrine/list?q=RS1G-13-F' | jq '.ok'
# –û–∂–∏–¥–∞–µ–º: true (–ù–ï SqliteError!)
```

### 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä—É—Å—Å–∫–∏–π –ø–æ–∏—Å–∫

```bash
curl -s 'http://127.0.0.1:9201/api/vitrine/list?q=—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä&limit=1' | jq '.ok, .meta.queryNorm.normalized'
# –û–∂–∏–¥–∞–µ–º: true, "transistor"
```

---

## üåê –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –í –ë–†–ê–£–ó–ï–†–ï

### URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–ì–ª–∞–≤–Ω–∞—è**: http://5.129.228.88:3000/
   - –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –¥–æ "–ß–¢–û –ò–©–£–¢ –õ–Æ–î–ò"
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –µ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
   - –ö–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –ª—é–±–æ–π ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `/search?q=<MPN>`

2. **–ü–æ–∏—Å–∫ (–∫—ç—à –ø—É—Å—Ç–æ–π)**: http://5.129.228.88:3000/search?q=TEST-RANDOM-999
   - –î–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∏—Ç—å—Å—è —Ä–µ–∂–∏–º "Live (SSE)"
   - –ü–æ–∫–∞–∑–∞—Ç—å "–ü–æ–∏—Å–∫..." –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
   - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (–µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã) –ø–æ—è–≤—è—Ç—Å—è —á–µ—Ä–µ–∑ 10-30 —Å–µ–∫—É–Ω–¥

3. **–ü–æ–∏—Å–∫ (–∫—ç—à –∑–∞–ø–æ–ª–Ω–µ–Ω)**: http://5.129.228.88:3000/search?q=FT232RL-REEL
   - –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ –∫—ç—à–∞
   - –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ "Live (SSE)" –≤—Ä—É—á–Ω—É—é

4. **–†—É—Å—Å–∫–∏–π –ø–æ–∏—Å–∫**: http://5.129.228.88:3000/search?q=—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: "–ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ: transistor"
   - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä—ã –∏–∑ –∫—ç—à–∞

5. **–ü–æ–∏—Å–∫ —Å –¥–µ—Ñ–∏—Å–æ–º**: http://5.129.228.88:3000/search?q=RS1G-13-F
   - –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–∫–∏ (FTS5 escaping)
   - –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–ª–∏ "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

---

## üìù GIT COMMIT

```bash
git add .
git commit -m "fix(search): React Hooks order + auto-live search

- Fixed React Hooks violation (early return after useEffect)
- Auto-trigger live search when cache is empty
- FTS5 escaping for special characters (-, *, OR, AND)
- Russian normalization (—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä ‚Üí transistor)

Closes: #ISSUE_NUMBER
"
```

---

## ‚úÖ –°–¢–ê–¢–£–°

- **React Hooks**: ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**
- **Auto-live search**: ‚úÖ **–î–û–ë–ê–í–õ–ï–ù–û**
- **FTS5 escaping**: ‚úÖ **–†–ê–ë–û–¢–ê–ï–¢**
- **–†—É—Å—Å–∫–∏–π –ø–æ–∏—Å–∫**: ‚úÖ **–†–ê–ë–û–¢–ê–ï–¢**
- **E2E —Ç–µ—Å—Ç—ã**: ‚ö†Ô∏è **–ù–ï–í–û–ó–ú–û–ñ–ù–û** (–ø—Ä–æ–±–ª–µ–º—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è PATH)
- **Browser —Ç–µ—Å—Ç**: ‚è≥ **–û–ñ–ò–î–ê–ï–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø**

---

**–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ Next.js –∏ –ø—Ä–æ–≤–µ—Ä—è–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ!** üöÄ
