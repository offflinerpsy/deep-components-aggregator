# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û ‚Äî –¢–ï–ü–ï–†–¨ –†–ê–ë–û–¢–ê–ï–¢

**–î–∞—Ç–∞**: 12 –æ–∫—Ç—è–±—Ä—è 2025  
**–í—Ä–µ–º—è**: 14:10 UTC  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–°–Å –†–ê–ë–û–¢–ê–ï–¢

---

## üêõ –ü—Ä–æ–±–ª–µ–º–∞ –∫–æ—Ç–æ—Ä—É—é —Ç—ã –Ω–∞—à—ë–ª

**URL**: http://5.129.228.88:3000/results?q=RS1G-13-F  
**–û—à–∏–±–∫–∞**: "Application error: a client-side exception has occurred"

**–ü—Ä–∏—á–∏–Ω–∞**: `SqliteError: no such column: 13`

---

## üîç Root Cause Analysis

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:

1. –§—Ä–æ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç `/api/vitrine/list?q=RS1G-13-F`
2. –ë—ç–∫–µ–Ω–¥ –≤—ã–∑—ã–≤–∞–µ—Ç FTS5 –ø–æ–∏—Å–∫: `WHERE search_rows_fts MATCH 'RS1G-13-F'`
3. SQLite FTS5 –ø–∞—Ä—Å–∏—Ç `-` –∫–∞–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä NOT: `RS1G NOT 13 NOT F`
4. FTS5 –ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –∫–æ–ª–æ–Ω–∫—É `13` ‚Üí **SqliteError: no such column: 13**
5. Express –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 500 Internal Server Error
6. Next.js SSR –ø–∞–¥–∞–µ—Ç ‚Üí –±–µ–ª—ã–π —ç–∫—Ä–∞–Ω

### –ü—Ä–æ–±–ª–µ–º–∞:

FTS5 —Å–∏–Ω—Ç–∞–∫—Å–∏—Å:
- `-` = –æ–ø–µ—Ä–∞—Ç–æ—Ä NOT (–º–∏–Ω—É—Å)
- `*` = prefix search
- `""` = phrase search
- `OR`, `AND`, `NEAR` = –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã

MPN —Ç–∏–ø–∞ `RS1G-13-F` —Å–æ–¥–µ—Ä–∂–∞—Ç `-` ‚Üí FTS5 –ø–∞—Ä—Å–∏—Ç –∫–∞–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

**–§–∞–π–ª**: `/opt/deep-agg/src/db/sql.mjs`  
**–§—É–Ω–∫—Ü–∏—è**: `searchCachedFts()`

### –ë—ã–ª–æ:

```javascript
export function searchCachedFts(db, query, options = {}) {
  const sql = `WHERE search_rows_fts MATCH ?`;
  const matches = db.prepare(sql).all(...weights, query, limit);
  //                                             ^^^^^ ‚Äî query as-is
}
```

**–ü—Ä–æ–±–ª–µ–º–∞**: `RS1G-13-F` ‚Üí FTS5 –ø–∞—Ä—Å–∏—Ç –∫–∞–∫ `RS1G NOT 13 NOT F`

### –°—Ç–∞–ª–æ:

```javascript
export function searchCachedFts(db, query, options = {}) {
  // Escape FTS5 special characters in query
  // Wrap query in double quotes to treat as literal phrase
  const escapedQuery = `"${query.replace(/"/g, '""')}"`;

  const sql = `WHERE search_rows_fts MATCH ?`;
  const matches = db.prepare(sql).all(...weights, escapedQuery, limit);
  //                                             ^^^^^^^^^^^^^ ‚Äî escaped
}
```

**–†–µ—à–µ–Ω–∏–µ**: –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –≤ `""` ‚Üí FTS5 –∏—â–µ—Ç —Ç–æ—á–Ω—É—é —Ñ—Ä–∞–∑—É (literal).

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞

### Test 1: –ó–∞–ø—Ä–æ—Å —Å –¥–µ—Ñ–∏—Å–æ–º

```bash
$ curl -s 'http://127.0.0.1:9201/api/vitrine/list?q=RS1G-13-F' | jq '.ok'
true  # ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç!
```

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: `SqliteError: no such column: 13`  
**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: `{ ok: true, rows: [...] }`

### Test 2: Smoke-—Ç–µ—Å—Ç

```bash
$ node scripts/smoke-test-frontend.mjs

‚úÖ All smoke tests passed!

1Ô∏è‚É£ Backend Vitrine API: 10 components
2Ô∏è‚É£ Russian Normalization: —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä ‚Üí transistor ‚úÖ
3Ô∏è‚É£ Frontend Rewrites: :3000/api/* ‚Üí :9201/api/* ‚úÖ
4Ô∏è‚É£ SSE Live Search: Content-Type: text/event-stream ‚úÖ
```

### Test 3: –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞

```bash
$ curl -s 'http://localhost:3000/api/vitrine/list?limit=5' | jq '.ok, (.rows | length)'
true
5  # ‚úÖ 5 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã
```

---

## üìã –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

```
M  src/db/sql.mjs (escape FTS5 special chars)
M  v0-components-aggregator-page/app/page.tsx (fetch from API)
A  scripts/smoke-test-frontend.mjs
A  docs/_artifacts/2025-10-12/* (documentation)
```

### –°–µ—Ä–≤–∏—Å—ã:

```bash
# Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
pm2 restart deep-agg  # ‚úÖ

# Frontend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
pkill next-server && PORT=3000 npm run dev  # ‚úÖ
```

---

## ‚úÖ –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (/)

**URL**: http://5.129.228.88:3000/

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
- –°–µ–∫—Ü–∏—è "–ß–¢–û –ò–©–£–¢ –õ–Æ–î–ò" –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ API
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å MPN, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–º, –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
- –ö–ª–∏–∫ –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `/search?q=<MPN>`

**–ü—Ä–∏–º–µ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞**:
```json
{
  "mpn": "MWDM2L-9SBSR1T-.110",
  "manufacturer": "Glenair",
  "source": "mouser"
}
```

### 2. –ü–æ–∏—Å–∫ —Å –¥–µ—Ñ–∏—Å–æ–º (/results?q=RS1G-13-F)

**URL**: http://5.129.228.88:3000/results?q=RS1G-13-F

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. SSR –≤—ã–∑—ã–≤–∞–µ—Ç `/api/vitrine/list?q=RS1G-13-F`
2. FTS5 –∏—â–µ—Ç `"RS1G-13-F"` (escaped) ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ–∏—Å–∫
3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: –¥–∏–æ–¥—ã RS1G-13-F (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –∫—ç—à–µ)
4. –ï—Å–ª–∏ –Ω–µ—Ç –≤ –∫—ç—à–µ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ó–∞–≥—Ä—É–∑–∫–∞..." –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç live search —á–µ—Ä–µ–∑ SSE

### 3. –†—É—Å—Å–∫–∏–π –ø–æ–∏—Å–∫ (/search?q=—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä)

**URL**: http://5.129.228.88:3000/search?q=—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: `—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä` ‚Üí `transistor`
2. SSE –∑–∞–ø—Ä–æ—Å –∫ `/api/live/search?q=—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä`
3. 4 –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (Mouser/DigiKey/TME/Farnell) –ø–æ–ª—É—á–∞—é—Ç `keyword=transistor`
4. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ç—Ä–∏–º—è—Ç—Å—è —á–µ—Ä–µ–∑ SSE —Å–æ–±—ã—Ç–∏—è

---

## üìù –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–¥–ª—è —Ç–µ–±—è)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: Backend API

```bash
curl -s 'http://127.0.0.1:9201/api/vitrine/list?limit=3' | jq '.ok, (.rows | length)'
# –û–∂–∏–¥–∞–µ–º: true, 3
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: Frontend rewrites

```bash
curl -s 'http://localhost:3000/api/vitrine/list?limit=3' | jq '.ok, (.rows | length)'
# –û–∂–∏–¥–∞–µ–º: true, 3
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ó–∞–ø—Ä–æ—Å —Å –¥–µ—Ñ–∏—Å–æ–º

```bash
curl -s 'http://127.0.0.1:9201/api/vitrine/list?q=RS1G-13-F' | jq '.ok'
# –û–∂–∏–¥–∞–µ–º: true (–ù–ï SqliteError!)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: Smoke-—Ç–µ—Å—Ç

```bash
node scripts/smoke-test-frontend.mjs
# –û–∂–∏–¥–∞–µ–º: ‚úÖ All smoke tests passed!
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 5: –í –±—Ä–∞—É–∑–µ—Ä–µ

1. –û—Ç–∫—Ä—ã—Ç—å: http://5.129.228.88:3000/
2. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –¥–æ "–ß–¢–û –ò–©–£–¢ –õ–Æ–î–ò"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –µ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–Ω–µ "–ó–∞–≥—Ä—É–∑–∫–∞...")
4. –ö–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –ª—é–±–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Üí –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å `/search?q=<MPN>`

---

## üéØ Acceptance Criteria

- [x] **–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ API
- [x] **–ó–∞–ø—Ä–æ—Å—ã —Å –¥–µ—Ñ–∏—Å–æ–º** (RS1G-13-F) —Ä–∞–±–æ—Ç–∞—é—Ç (–Ω–µ SqliteError)
- [x] **–†—É—Å—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã** (—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä) –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- [x] **Frontend rewrites** –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (`:3000/api/*` ‚Üí `:9201/api/*`)
- [x] **SSE Live Search** —Ä–∞–±–æ—Ç–∞–µ—Ç (Content-Type: text/event-stream)
- [x] **Smoke-—Ç–µ—Å—Ç—ã** –ø—Ä–æ—Ö–æ–¥—è—Ç (4/4 ‚úÖ)

---

## üìä –ë—ã–ª–æ ‚Üí –°—Ç–∞–ª–æ

| –ß—Ç–æ | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|-----|----------------|-------------------|
| `/api/vitrine/list?q=RS1G-13-F` | SqliteError: no such column: 13 | ‚úÖ `{ ok: true, rows: [...] }` |
| –ì–ª–∞–≤–Ω–∞—è `/` | Hardcoded 28 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ | ‚úÖ Fetch –∫ `/api/vitrine/list?limit=28` |
| FTS5 –∑–∞–ø—Ä–æ—Å—ã | –°–ø–µ—Ü.—Å–∏–º–≤–æ–ª—ã –ø–∞—Ä—Å—è—Ç—Å—è –∫–∞–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã | ‚úÖ Escaped –≤ `""` (literal phrase) |
| –§—Ä–æ–Ω—Ç `:3000` | –ë–µ–ª—ã–π —ç–∫—Ä–∞–Ω (500 error) | ‚úÖ –†–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| Smoke-—Ç–µ—Å—Ç—ã | –ù–µ –±—ã–ª–æ | ‚úÖ 4/4 passed |

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ** http://5.129.228.88:3000/
2. ‚úÖ **–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫** —Å –¥–µ—Ñ–∏—Å–æ–º (RS1G-13-F)
3. ‚úÖ **–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä—É—Å—Å–∫–∏–π –ø–æ–∏—Å–∫** (—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä)
4. ‚úÖ **–°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã** –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
5. ‚è≥ **–ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π** (conventional commits)
6. ‚è≥ **E2E —Ç–µ—Å—Ç—ã** (Playwright)

---

**–¢–µ–ø–µ—Ä—å –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü—Ä–æ–≤–µ—Ä—è–π.** ‚úÖ
