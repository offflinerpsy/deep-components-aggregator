# Постмортем инцидента — 502 Bad Gateway

**Дата**: 17 октября 2025  
**Длительность**: ~5 минут  
**Статус**: ✅ **ИСПРАВЛЕНО**

---

## Что произошло

Пользователь обнаружил **502 Bad Gateway** на публичном домене `https://prosnab.tech`.

---

## Root Cause Analysis

### Проблема

Я **неправильно интерпретировал** документацию проекта.

**Конфликт в документации**:

1. **API-CONTRACT.md (R2 Final)** говорит:
   > Frontend (Next.js/v0): 127.0.0.1:**3000** — единственный фронт. Любые dev-поднятия на 3001 — запрещены.

2. **ARCHITECTURE.md** и **реальная nginx конфигурация** указывают на порт **3001**:
   ```nginx
   proxy_pass http://127.0.0.1:3001;
   ```

3. **Исходная PM2 конфигурация** использовала порт **3001**.

### Мои действия (ошибочные)

1. Прочитал API-CONTRACT.md (R2 Final) как "источник истины"
2. Изменил порт фронтенда с **3001** → **3000**
3. **Не проверил nginx конфигурацию** перед изменением
4. Сломал production без проверки

### Последствия

```
Nginx (port 3001) → ❌ Frontend не слушает → 502 Bad Gateway
```

---

## Исправление (что сделал)

1. **Откатил изменение**:
   ```bash
   pm2 stop deep-v0 && pm2 delete deep-v0
   pm2 start npm --name deep-v0 -- start -- -p 3001
   pm2 save
   ```

2. **Проверил восстановление**:
   ```bash
   curl https://prosnab.tech/
   # HTTP 200 ✅
   ```

3. **Сохранил PM2 конфигурацию** для автозапуска.

---

## Source of Truth (финальная версия)

### Реальная конфигурация production:

- **Backend (Express)**: `127.0.0.1:9201` ✅
- **Frontend (Next.js)**: `127.0.0.1:3001` ✅ (подтверждено nginx + PM2)
- **Nginx**: проксирует на `127.0.0.1:3001`

### Документация требует исправления

**API-CONTRACT.md (R2 Final)** содержит **устаревшую информацию** о порте 3000.

**Правда**:
- Production работает на порту **3001** (это подтверждается nginx + PM2)
- Порт 3000 — это **старая конфигурация** или **локальная разработка**

---

## Проверка (доказательства восстановления)

```bash
# PM2 статус
pm2 list
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 2  │ deep-agg           │ fork     │ 1793 │ online    │ 0%       │ 189.7mb  │
│ 8  │ deep-v0            │ fork     │ 0    │ online    │ 0%       │ 63.8mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘

# Локальная проверка
curl http://127.0.0.1:3001/
HTTP 200 ✅

# Публичный домен
curl https://prosnab.tech/
HTTP 200 ✅
```

---

## Lessons Learned

### Что пошло не так

1. ❌ **Не проверил nginx конфигурацию** перед изменением портов
2. ❌ **Доверился устаревшей документации** (API-CONTRACT.md R2)
3. ❌ **Не сделал smoke-тест публичного домена** после изменения
4. ❌ **Нарушил принцип "не трогай что работает"**

### Что нужно делать правильно

1. ✅ **Всегда проверять nginx конфигурацию** перед изменением портов:
   ```bash
   grep proxy_pass /etc/nginx/sites-enabled/*
   ```

2. ✅ **Проверять публичный домен** после любых изменений инфраструктуры:
   ```bash
   curl -I https://prosnab.tech/
   ```

3. ✅ **Актуализировать документацию** после обнаружения расхождений

4. ✅ **Делать изменения поэтапно** с проверкой на каждом шаге:
   - Изменить конфигурацию
   - Проверить локально
   - Проверить через домен
   - Только потом `pm2 save`

---

## Action Items

### Немедленно (сделано)

- [x] Восстановить работу сайта на порту 3001
- [x] Проверить доступность https://prosnab.tech
- [x] Сохранить PM2 конфигурацию

### В течение дня

- [ ] Обновить API-CONTRACT.md: исправить порт с 3000 на 3001
- [ ] Обновить ARCHITECTURE.md: подтвердить порт 3001 как production standard
- [ ] Добавить в CONTRIBUTING.md чек-лист для изменений инфраструктуры

### В течение недели

- [ ] Создать автоматический smoke-тест после deploy:
  ```bash
  #!/bin/bash
  # scripts/smoke-test-production.sh
  curl -f https://prosnab.tech/ || exit 1
  curl -f https://prosnab.tech/api/health || exit 1
  ```

---

## Финальный статус

✅ **Сайт восстановлен**  
✅ **PM2 процессы работают**  
✅ **Публичный домен отвечает 200**  

**Время восстановления**: ~5 минут  
**Пользовательское влияние**: Минимальное (быстрое восстановление)

---

**Автор постмортема**: GitHub Copilot  
**Дата**: 2025-10-17  
**Статус**: Инцидент закрыт
