<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Поиск — Deep Aggregator</title>
  <link rel="stylesheet" href="/styles/design-system.css">
</head>
<body>
  <div class="container">
    <!-- Page Header -->
    <div style="margin-bottom: 32px;">
      <h1 style="font-size: 32px; font-weight: 700; margin: 0 0 8px 0;">Поиск компонентов</h1>
      <p style="color: hsl(var(--muted-foreground)); margin: 0;">Найдите нужные компоненты среди миллионов позиций</p>
    </div>

    <!-- Search Form -->
    <div class="card" style="margin-bottom: 32px;">
      <div class="card-content" style="padding: 24px;">
        <form id="search-form" data-testid="search-form" style="display: flex; gap: 12px; align-items: end;">
          <div style="flex: 1;">
            <label for="search-input" style="display: block; font-weight: 500; margin-bottom: 8px;">Поисковый запрос</label>
            <input 
              type="text" 
              name="q" 
              id="search-input" 
              placeholder="Поиск по MPN или описанию (например: LM317T, транзистор 2N3904)" 
              class="input"
              autocomplete="off"
            />
          </div>
          
          <button type="submit" class="btn btn-primary btn-lg">
            <svg class="icon" style="margin-right: 8px;" viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
            Найти
          </button>
        </form>
      </div>
    </div>

    <!-- View Controls -->
    <div class="card" style="margin-bottom: 24px; display: none;" id="view-controls">
      <div class="card-content" style="padding: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div class="results-summary" id="results-summary">Введите запрос для поиска</div>
          
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-ghost btn-sm" id="view-table" onclick="switchView('table')">
              <svg class="icon-sm" style="margin-right: 4px;" viewBox="0 0 24 24">
                <path d="M3 3h18v18H3zM21 9H3M21 15H3M12 3v18"/>
              </svg>
              Таблица
            </button>
            <button class="btn btn-ghost btn-sm" id="view-cards" onclick="switchView('cards')">
              <svg class="icon-sm" style="margin-right: 4px;" viewBox="0 0 24 24">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
              </svg>
              Карточки
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <section id="results-section" style="display: none;">
      <div id="results-container">
        <!-- Table View -->
        <div class="card" id="table-view">
          <div class="card-content" style="padding: 0;">
            <table class="table">
              <thead>
                <tr>
                  <th style="width: 80px;">Фото</th>
                  <th style="width: 120px;">Производитель</th>
                  <th style="width: 150px;">MPN</th>
                  <th>Описание</th>
                  <th style="width: 100px;">Регион</th>
                  <th style="width: 120px;">Цена ₽</th>
                  <th style="width: 100px;">Действие</th>
                </tr>
              </thead>
              <tbody id="results-tbody">
                <!-- Results will be inserted here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Cards View -->
        <div id="cards-view" style="display: none;">
          <div class="grid grid-cols-3 gap-4" id="results-cards">
            <!-- Card results will be inserted here -->
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div style="display: flex; justify-content: center; align-items: center; gap: 16px; margin-top: 24px;" id="pagination" style="display: none;">
        <button class="btn btn-ghost btn-sm" id="prev-page" disabled>
          <svg class="icon-sm" style="margin-right: 4px;" viewBox="0 0 24 24">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
          Назад
        </button>
        
        <span id="page-info" style="color: hsl(var(--muted-foreground)); font-size: 14px;">Страница 1 из 1</span>
        
        <button class="btn btn-ghost btn-sm" id="next-page" disabled>
          Вперёд
          <svg class="icon-sm" style="margin-left: 4px;" viewBox="0 0 24 24">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      </div>
    </section>
  </div>

  <script src="/js/dashboard-layout.js"></script>

  <script src="/js/dashboard-layout.js"></script>
  <script src="/ui/search-enhanced.js"></script>
  <script>
    // Global view state
    let currentView = 'table';

    // Switch between table and cards view
    window.switchView = function(view) {
      currentView = view;
      
      const tableView = document.getElementById('table-view');
      const cardsView = document.getElementById('cards-view');
      const tableBtn = document.getElementById('view-table');
      const cardsBtn = document.getElementById('view-cards');
      
      if (view === 'table') {
        tableView.style.display = 'block';
        cardsView.style.display = 'none';
        tableBtn.classList.add('btn-primary');
        tableBtn.classList.remove('btn-ghost');
        cardsBtn.classList.add('btn-ghost');
        cardsBtn.classList.remove('btn-primary');
      } else {
        tableView.style.display = 'none';
        cardsView.style.display = 'block';
        cardsBtn.classList.add('btn-primary');
        cardsBtn.classList.remove('btn-ghost');
        tableBtn.classList.add('btn-ghost');
        tableBtn.classList.remove('btn-primary');
      }
    };

    // Initialize search from URL parameters AFTER search-enhanced.js loads
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const initialQuery = urlParams.get('q');
      if (initialQuery && typeof window.performSearch === 'function') {
        document.getElementById('search-input').value = initialQuery;
        window.performSearch(initialQuery);
      }
      
      // Initialize default view
      switchView('table');
    });

    // Override search result rendering to support both views
    const originalRenderResults = window.renderSearchResults;
    window.renderSearchResults = function(results) {
      // Show view controls
      document.getElementById('view-controls').style.display = 'block';
      
      // Call original function for table view
      if (originalRenderResults) {
        originalRenderResults(results);
      }
      
      // Render cards view
      renderCardsView(results);
    };

    function renderCardsView(results) {
      const container = document.getElementById('results-cards');
      
      if (!results || results.length === 0) {
        container.innerHTML = `
          <div style="grid-column: span 3; text-align: center; padding: 48px; color: hsl(var(--muted-foreground));">
            <svg style="width: 48px; height: 48px; margin: 0 auto 16px; opacity: 0.5;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
            <h3 style="margin: 0 0 8px 0;">Результаты не найдены</h3>
            <p style="margin: 0;">Попробуйте изменить поисковый запрос</p>
          </div>
        `;
        return;
      }

      container.innerHTML = results.map(result => `
        <div class="card hover-card">
          <div class="card-content" style="padding: 20px;">
            <div style="display: flex; gap: 16px; margin-bottom: 16px;">
              <img 
                src="${result.imageUrl || '/placeholder-component.png'}" 
                alt="${result.mpn}"
                style="width: 64px; height: 64px; border-radius: calc(var(--radius)); object-fit: cover; border: 1px solid hsl(var(--border));"
                onerror="this.src='/placeholder-component.png'"
              />
              <div style="flex: 1; min-width: 0;">
                <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 4px 0; color: hsl(var(--foreground));">${result.mpn}</h4>
                <p style="font-size: 14px; color: hsl(var(--muted-foreground)); margin: 0 0 8px 0;">${result.manufacturer}</p>
                <span class="badge badge-secondary">${result.src}</span>
              </div>
            </div>
            
            <p style="font-size: 14px; color: hsl(var(--muted-foreground)); margin: 0 0 16px 0; line-height: 1.4; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
              ${result.description || 'Описание недоступно'}
            </p>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-size: 18px; font-weight: 600; color: #16a34a;">₽${(result.price || 0).toLocaleString('ru')}</div>
                ${result.priceRange ? `<div style="font-size: 12px; color: hsl(var(--muted-foreground));">${result.priceRange}</div>` : ''}
              </div>
              
              <a href="${result.productUrl || '#'}" class="btn btn-primary btn-sm" style="text-decoration: none;">
                Подробнее
              </a>
            </div>
          </div>
        </div>
      `).join('');
    }
  </script>
</body>
</html>