<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Settings</title>
  <link rel="stylesheet" href="/ui/auth.css" />
  <style>
    .container{max-width:720px;margin:40px auto;padding:24px;background:#111;border:1px solid #333;border-radius:12px;color:#eee}
    .row{display:flex;gap:16px;align-items:center;margin:12px 0}
    label{width:220px;color:#bbb}
    input{flex:1;padding:10px 12px;border:1px solid #333;background:#0b0b0b;color:#eee;border-radius:8px}
    .actions{display:flex;gap:12px;margin-top:20px}
    button{padding:10px 16px;border:1px solid #3a3;border-radius:8px;background:#162b16;color:#d6f5d6;cursor:pointer}
    button.secondary{border-color:#555;background:#1a1a1a;color:#ccc}
    .hint{color:#aaa;font-size:12px}
    .status{margin-top:12px;font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <h2>Pricing Policy</h2>
    <div class="row">
      <label for="markup_percent">Markup Percent</label>
      <input id="markup_percent" type="number" step="0.01" min="0" max="10" placeholder="0.30" />
    </div>
    <div class="row">
      <label for="markup_fixed_rub">Fixed RUB</label>
      <input id="markup_fixed_rub" type="number" step="1" min="0" max="100000" placeholder="500" />
    </div>
    <div class="hint">Final price = ceil(base_rub * (1 + markup_percent) + markup_fixed_rub)</div>

    <div class="actions">
      <button id="save">Save</button>
      <button class="secondary" id="reload">Reload</button>
    </div>

    <div id="calc" class="hint" style="margin-top:16px"></div>
    <div id="status" class="status"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function exampleCalc() {
      const mp = parseFloat($("markup_percent").value || '0');
      const fx = parseFloat($("markup_fixed_rub").value || '0');
      const base = 1000;
      const final = Math.ceil(base * (1 + mp) + fx);
      $("calc").textContent = `Example: base 1000 â†’ final ${final} RUB`;
    }

    async function load() {
      try {
        const res = await fetch('/api/admin/settings/pricing', { credentials: 'include' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        $("markup_percent").value = data.policy.markup_percent;
        $("markup_fixed_rub").value = data.policy.markup_fixed_rub;
        exampleCalc();
        $("status").textContent = `Loaded. Updated at: ${new Date(data.updated_at).toLocaleString()}`;
      } catch (e) {
        $("status").textContent = `Failed to load: ${e.message}`;
      }
    }

    async function save() {
      const body = {
        markup_percent: parseFloat($("markup_percent").value || '0'),
        markup_fixed_rub: parseFloat($("markup_fixed_rub").value || '0'),
      };
      try {
        const res = await fetch('/api/admin/settings/pricing', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || data.error || `HTTP ${res.status}`);
        $("status").textContent = `Saved. New updated_at: ${new Date(data.updated_at).toLocaleString()}`;
      } catch (e) {
        $("status").textContent = `Save failed: ${e.message}`;
      }
    }

    $("save").addEventListener('click', save);
    $("reload").addEventListener('click', load);
    $("markup_percent").addEventListener('input', exampleCalc);
    $("markup_fixed_rub").addEventListener('input', exampleCalc);

    load();
  </script>
</body>
</html>
