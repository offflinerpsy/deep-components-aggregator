<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Заказы — Deep Aggregator</title>
  <link rel="stylesheet" href="/public/styles/design-system.css">
</head>
<body>
  <div class="container">
    <!-- Page Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
      <div>
        <h1 style="font-size: 32px; font-weight: 700; margin: 0 0 8px 0;">Мои заказы</h1>
        <p style="color: hsl(var(--muted-foreground)); margin: 0;">История и статус ваших заказов</p>
      </div>
      <a href="search.html" class="btn btn-primary btn-lg" style="text-decoration: none;">
        <svg class="icon" style="margin-right: 8px;" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        Новый заказ
      </a>
    </div>

    <!-- Order Stats -->
    <div class="grid grid-cols-4 gap-4" style="margin-bottom: 32px;">
      <div class="card">
        <div class="card-content" style="padding: 20px;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
              <p style="font-size: 14px; color: hsl(var(--muted-foreground)); margin: 0 0 4px 0;">Всего заказов</p>
              <p style="font-size: 24px; font-weight: 700; margin: 0;" id="total-orders">—</p>
            </div>
            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: hsl(var(--chart-1)); color: white; display: flex; align-items: center; justify-content: center;">
              <svg class="icon" viewBox="0 0 24 24">
                <circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-content" style="padding: 20px;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
              <p style="font-size: 14px; color: hsl(var(--muted-foreground)); margin: 0 0 4px 0;">В обработке</p>
              <p style="font-size: 24px; font-weight: 700; margin: 0;" id="pending-orders">—</p>
            </div>
            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: hsl(var(--chart-2)); color: white; display: flex; align-items: center; justify-content: center;">
              <svg class="icon" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6"/><path d="m9 9 3-3 3 3"/><path d="m9 15 3 3 3-3"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-content" style="padding: 20px;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
              <p style="font-size: 14px; color: hsl(var(--muted-foreground)); margin: 0 0 4px 0;">Выполнено</p>
              <p style="font-size: 24px; font-weight: 700; margin: 0;" id="completed-orders">—</p>
            </div>
            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: #16a34a; color: white; display: flex; align-items: center; justify-content: center;">
              <svg class="icon" viewBox="0 0 24 24">
                <path d="M20 6 9 17l-5-5"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-content" style="padding: 20px;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
              <p style="font-size: 14px; color: hsl(var(--muted-foreground)); margin: 0 0 4px 0;">Общая сумма</p>
              <p style="font-size: 24px; font-weight: 700; margin: 0;" id="total-amount">—</p>
            </div>
            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: hsl(var(--chart-4)); color: white; display: flex; align-items: center; justify-content: center;">
              <svg class="icon" viewBox="0 0 24 24">
                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card" style="margin-bottom: 24px;">
      <div class="card-content" style="padding: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 16px; align-items: end;">
          <div>
            <label for="status-filter" style="display: block; font-weight: 500; margin-bottom: 8px;">Статус</label>
            <select id="status-filter" class="input">
              <option value="">Все статусы</option>
              <option value="pending">В обработке</option>
              <option value="confirmed">Подтвержден</option>
              <option value="shipped">Отправлен</option>
              <option value="delivered">Доставлен</option>
              <option value="cancelled">Отменен</option>
            </select>
          </div>
          
          <div>
            <label for="provider-filter" style="display: block; font-weight: 500; margin-bottom: 8px;">Поставщик</label>
            <select id="provider-filter" class="input">
              <option value="">Все поставщики</option>
              <option value="digikey">DigiKey</option>
              <option value="tme">TME</option>
              <option value="mouser">Mouser</option>
              <option value="farnell">Farnell</option>
            </select>
          </div>
          
          <div>
            <label for="date-range" style="display: block; font-weight: 500; margin-bottom: 8px;">Период</label>
            <select id="date-range" class="input">
              <option value="all">Весь период</option>
              <option value="week">Последняя неделя</option>
              <option value="month">Последний месяц</option>
              <option value="quarter">Последний квартал</option>
              <option value="year">Последний год</option>
            </select>
          </div>
          
          <button class="btn btn-ghost btn-md" id="reset-filters" style="height: 40px;">
            <svg class="icon-sm" style="margin-right: 4px;" viewBox="0 0 24 24">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>
            </svg>
            Сбросить
          </button>
        </div>
      </div>
    </div>

    <!-- Orders List -->
    <div class="card">
      <div class="card-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h3 class="card-title">История заказов</h3>
            <p class="card-description" id="orders-summary">Загрузка заказов...</p>
          </div>
          <button class="btn btn-ghost btn-sm" id="refresh-orders">
            <svg class="icon-sm" style="margin-right: 4px;" viewBox="0 0 24 24">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>
            </svg>
            Обновить
          </button>
        </div>
      </div>
      <div class="card-content" style="padding: 0;">
        <div id="orders-list">
          <!-- Orders will be populated here -->
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div style="display: flex; justify-content: center; align-items: center; gap: 16px; margin-top: 24px;">
      <button class="btn btn-ghost btn-sm" id="prev-page" disabled>
        <svg class="icon-sm" style="margin-right: 4px;" viewBox="0 0 24 24">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        Назад
      </button>
      
      <span id="page-info" style="color: hsl(var(--muted-foreground)); font-size: 14px;">Страница 1 из 1</span>
      
      <button class="btn btn-ghost btn-sm" id="next-page" disabled>
        Вперёд
        <svg class="icon-sm" style="margin-left: 4px;" viewBox="0 0 24 24">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
    </div>
  </div>

  <style>
    /* Order card styling */
    .order-card {
      border-bottom: 1px solid hsl(var(--border));
      padding: 24px;
      transition: background-color 0.2s ease;
    }

    .order-card:hover {
      background-color: hsl(var(--muted) / 0.3);
    }

    .order-card:last-child {
      border-bottom: none;
    }

    /* Status badge colors */
    .status-pending { background-color: #f59e0b; color: white; }
    .status-confirmed { background-color: #3b82f6; color: white; }
    .status-shipped { background-color: #8b5cf6; color: white; }
    .status-delivered { background-color: #10b981; color: white; }
    .status-cancelled { background-color: #ef4444; color: white; }

    /* Order items styling */
    .order-items {
      background-color: hsl(var(--muted) / 0.1);
      border-radius: calc(var(--radius));
      padding: 12px;
      margin-top: 12px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid hsl(var(--border));
    }

    .order-item:last-child {
      border-bottom: none;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .grid-cols-4 {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      .card-content div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
      }
      
      .order-card {
        padding: 16px !important;
      }
    }
  </style>

  <script src="/public/js/dashboard-layout.js"></script>
  <script>
    class OrdersController {
      constructor() {
        this.orders = [];
        this.filteredOrders = [];
        this.currentPage = 1;
        this.itemsPerPage = 10;
        this.filters = {
          status: '',
          provider: '',
          dateRange: 'all'
        };
        this.init();
      }

      init() {
        this.bindFilters();
        this.bindPagination();
        this.loadOrders();
      }

      bindFilters() {
        const statusFilter = document.getElementById('status-filter');
        const providerFilter = document.getElementById('provider-filter');
        const dateRange = document.getElementById('date-range');
        const resetBtn = document.getElementById('reset-filters');

        statusFilter.addEventListener('change', (e) => {
          this.filters.status = e.target.value;
          this.applyFilters();
        });

        providerFilter.addEventListener('change', (e) => {
          this.filters.provider = e.target.value;
          this.applyFilters();
        });

        dateRange.addEventListener('change', (e) => {
          this.filters.dateRange = e.target.value;
          this.applyFilters();
        });

        resetBtn.addEventListener('click', () => {
          this.filters = { status: '', provider: '', dateRange: 'all' };
          statusFilter.value = '';
          providerFilter.value = '';
          dateRange.value = 'all';
          this.applyFilters();
        });

        // Refresh button
        document.getElementById('refresh-orders').addEventListener('click', () => {
          this.loadOrders();
        });
      }

      bindPagination() {
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');

        prevBtn.addEventListener('click', () => {
          if (this.currentPage > 1) {
            this.currentPage--;
            this.renderOrders();
          }
        });

        nextBtn.addEventListener('click', () => {
          const totalPages = Math.ceil(this.filteredOrders.length / this.itemsPerPage);
          if (this.currentPage < totalPages) {
            this.currentPage++;
            this.renderOrders();
          }
        });
      }

      async loadOrders() {
        // Simulate API call - in real app this would fetch from backend
        this.orders = [
          {
            id: 'ORD-2025-001',
            date: '2025-01-09',
            status: 'delivered',
            provider: 'DigiKey',
            total: 2450,
            items: [
              { mpn: 'LM317T', qty: 5, price: 85 },
              { mpn: 'BC547', qty: 20, price: 12 }
            ],
            trackingNumber: 'DK123456789'
          },
          {
            id: 'ORD-2025-002',
            date: '2025-01-08',
            status: 'shipped',
            provider: 'TME',
            total: 1890,
            items: [
              { mpn: 'Arduino Uno R3', qty: 2, price: 2450 },
              { mpn: '1N4007', qty: 50, price: 8 }
            ],
            trackingNumber: 'TME987654321'
          },
          {
            id: 'ORD-2025-003',
            date: '2025-01-07',
            status: 'confirmed',
            provider: 'Mouser',
            total: 890,
            items: [
              { mpn: 'ESP32-DevKitC', qty: 1, price: 890 }
            ],
            estimatedDelivery: '2025-01-12'
          },
          {
            id: 'ORD-2025-004',
            date: '2025-01-06',
            status: 'pending',
            provider: 'Farnell',
            total: 340,
            items: [
              { mpn: 'BC547', qty: 10, price: 12 },
              { mpn: '1N4007', qty: 25, price: 8 }
            ]
          }
        ];

        this.applyFilters();
        this.updateStats();
      }

      applyFilters() {
        let filtered = [...this.orders];

        // Status filter
        if (this.filters.status) {
          filtered = filtered.filter(order => order.status === this.filters.status);
        }

        // Provider filter
        if (this.filters.provider) {
          filtered = filtered.filter(order => order.provider.toLowerCase() === this.filters.provider);
        }

        // Date range filter
        if (this.filters.dateRange !== 'all') {
          const now = new Date();
          const cutoffDate = new Date();
          
          switch (this.filters.dateRange) {
            case 'week':
              cutoffDate.setDate(now.getDate() - 7);
              break;
            case 'month':
              cutoffDate.setMonth(now.getMonth() - 1);
              break;
            case 'quarter':
              cutoffDate.setMonth(now.getMonth() - 3);
              break;
            case 'year':
              cutoffDate.setFullYear(now.getFullYear() - 1);
              break;
          }
          
          filtered = filtered.filter(order => new Date(order.date) >= cutoffDate);
        }

        this.filteredOrders = filtered;
        this.currentPage = 1;
        this.renderOrders();
        this.updateSummary();
      }

      updateStats() {
        const totalOrders = this.orders.length;
        const pendingOrders = this.orders.filter(o => o.status === 'pending' || o.status === 'confirmed').length;
        const completedOrders = this.orders.filter(o => o.status === 'delivered').length;
        const totalAmount = this.orders.reduce((sum, order) => sum + order.total, 0);

        document.getElementById('total-orders').textContent = totalOrders;
        document.getElementById('pending-orders').textContent = pendingOrders;
        document.getElementById('completed-orders').textContent = completedOrders;
        document.getElementById('total-amount').textContent = `₽${totalAmount.toLocaleString('ru')}`;
      }

      updateSummary() {
        const summary = document.getElementById('orders-summary');
        summary.textContent = `Показано ${this.filteredOrders.length} из ${this.orders.length} заказов`;
      }

      renderOrders() {
        const startIndex = (this.currentPage - 1) * this.itemsPerPage;
        const endIndex = startIndex + this.itemsPerPage;
        const pageOrders = this.filteredOrders.slice(startIndex, endIndex);

        const container = document.getElementById('orders-list');
        
        if (pageOrders.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 48px; color: hsl(var(--muted-foreground));">
              <svg style="width: 48px; height: 48px; margin: 0 auto 16px; opacity: 0.5;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
              </svg>
              <h3 style="margin: 0 0 8px 0;">Заказы не найдены</h3>
              <p style="margin: 0;">Измените фильтры или создайте новый заказ</p>
            </div>
          `;
          return;
        }

        container.innerHTML = pageOrders.map(order => `
          <div class="order-card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
              <div>
                <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 4px 0;">${order.id}</h4>
                <p style="color: hsl(var(--muted-foreground)); margin: 0; font-size: 14px;">${this.formatDate(order.date)} • ${order.provider}</p>
              </div>
              <div style="text-align: right;">
                <span class="badge status-${order.status}">${this.getStatusText(order.status)}</span>
                <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">₽${order.total.toLocaleString('ru')}</div>
              </div>
            </div>

            <div class="order-items">
              <div style="font-size: 14px; font-weight: 500; margin-bottom: 8px; color: hsl(var(--muted-foreground));">Товары (${order.items.length}):</div>
              ${order.items.map(item => `
                <div class="order-item">
                  <div>
                    <span style="font-weight: 500;">${item.mpn}</span>
                    <span style="color: hsl(var(--muted-foreground)); margin-left: 8px;">×${item.qty}</span>
                  </div>
                  <span style="font-weight: 600;">₽${(item.price * item.qty).toLocaleString('ru')}</span>
                </div>
              `).join('')}
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
              <div style="display: flex; gap: 8px;">
                ${order.trackingNumber ? `
                  <button class="btn btn-ghost btn-sm" onclick="window.open('https://track.example.com/${order.trackingNumber}', '_blank')">
                    <svg class="icon-sm" style="margin-right: 4px;" viewBox="0 0 24 24">
                      <path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/>
                    </svg>
                    Отследить
                  </button>
                ` : ''}
                <button class="btn btn-ghost btn-sm" onclick="alert('Детали заказа ${order.id}')">
                  <svg class="icon-sm" style="margin-right: 4px;" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                  </svg>
                  Детали
                </button>
              </div>
              
              ${order.estimatedDelivery ? `
                <span style="font-size: 12px; color: hsl(var(--muted-foreground));">
                  Ожидаемая доставка: ${this.formatDate(order.estimatedDelivery)}
                </span>
              ` : ''}
            </div>
          </div>
        `).join('');

        this.updatePagination();
      }

      updatePagination() {
        const totalPages = Math.ceil(this.filteredOrders.length / this.itemsPerPage);
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');

        prevBtn.disabled = this.currentPage === 1;
        nextBtn.disabled = this.currentPage === totalPages || totalPages === 0;
        pageInfo.textContent = `Страница ${this.currentPage} из ${Math.max(1, totalPages)}`;
      }

      formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ru-RU', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }

      getStatusText(status) {
        const statusTexts = {
          pending: 'В обработке',
          confirmed: 'Подтвержден',
          shipped: 'Отправлен',
          delivered: 'Доставлен',
          cancelled: 'Отменен'
        };
        return statusTexts[status] || status;
      }
    }

    // Initialize when page loads
    window.addEventListener('load', () => {
      new OrdersController();
    });
  </script>
</body>
</html>