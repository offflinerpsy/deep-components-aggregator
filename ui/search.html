<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Поиск — Deep Aggregator</title>
  <link rel="stylesheet" href="/public/styles/design-system.css">
</head>
<body>
  <div class="container">
    <!-- Page Header -->
    <div style="margin-bottom: 32px;">
      <h1 style="font-size: 32px; font-weight: 700; margin: 0 0 8px 0;">Поиск компонентов</h1>
      <p style="color: hsl(var(--muted-foreground)); margin: 0;">Найдите электронные компоненты из каталогов всех поставщиков</p>
    </div>

    <!-- Search Form -->
    <div class="card" style="margin-bottom: 32px;">
      <div class="card-content" style="padding: 24px;">
        <form id="search-form" data-testid="search-form" style="display: flex; gap: 16px; align-items: flex-end;">
          <div style="flex: 1;">
            <label for="search-input" style="display: block; font-weight: 500; margin-bottom: 8px;">Поисковый запрос</label>
            <input 
              type="text" 
              name="q" 
              id="search-input" 
              class="input" 
              placeholder="MPN, производитель или описание (например: LM317T, транзистор BC547)" 
              autocomplete="off"
              style="font-size: 16px; height: 48px;"
            >
          </div>
          <button type="submit" class="btn btn-primary btn-lg" style="height: 48px; padding: 0 32px;">
            <svg class="icon" style="margin-right: 8px;" viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
            Найти
          </button>
        </form>
      </div>
    </div>

    <!-- Search Results -->
    <div id="results-section" style="display: none;">
      <!-- Results Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
          <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 4px 0;">Результаты поиска</h2>
          <p id="results-summary" style="color: hsl(var(--muted-foreground)); margin: 0; font-size: 14px;">Найдено компонентов</p>
        </div>
        
        <!-- View Toggle -->
        <div style="display: flex; gap: 8px; align-items: center;">
          <span style="font-size: 14px; color: hsl(var(--muted-foreground)); margin-right: 8px;">Вид:</span>
          <button class="btn btn-ghost btn-sm" id="table-view-btn">
            <svg class="icon-sm" style="margin-right: 4px;" viewBox="0 0 24 24">
              <path d="M3 6h18M3 12h18M3 18h18"/>
            </svg>
            Таблица
          </button>
          <button class="btn btn-ghost btn-sm" id="card-view-btn">
            <svg class="icon-sm" style="margin-right: 4px;" viewBox="0 0 24 24">
              <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
            </svg>
            Карточки
          </button>
        </div>
      </div>

      <!-- Results Container -->
      <div id="results-container">
        <!-- Table View -->
        <div class="card" id="table-view">
          <table class="table">
            <thead class="table-header">
              <tr>
                <th class="table-head" style="width: 80px;">Фото</th>
                <th class="table-head" style="width: 120px;">Производитель</th>
                <th class="table-head" style="width: 150px;">MPN</th>
                <th class="table-head">Описание</th>
                <th class="table-head" style="width: 100px;">Регион</th>
                <th class="table-head" style="width: 120px; text-align: right;">Цена ₽</th>
                <th class="table-head" style="width: 100px; text-align: center;">Действие</th>
              </tr>
            </thead>
            <tbody class="table-body" id="results-tbody">
              <!-- Results will be inserted here -->
            </tbody>
          </table>
        </div>

        <!-- Card View -->
        <div id="card-view" style="display: none;">
          <div class="grid grid-cols-3 gap-4" id="results-cards">
            <!-- Card results will be inserted here -->
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div style="display: flex; justify-content: center; align-items: center; gap: 16px; margin-top: 32px;" id="pagination" style="display: none;">
        <button class="btn btn-ghost btn-sm" id="prev-page" disabled>
          <svg class="icon-sm" style="margin-right: 4px;" viewBox="0 0 24 24">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
          Назад
        </button>
        
        <span id="page-info" style="color: hsl(var(--muted-foreground)); font-size: 14px;">Страница 1 из 1</span>
        
        <button class="btn btn-ghost btn-sm" id="next-page" disabled>
          Вперёд
          <svg class="icon-sm" style="margin-left: 4px;" viewBox="0 0 24 24">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" style="text-align: center; padding: 64px 24px; color: hsl(var(--muted-foreground)); display: none;">
      <svg style="width: 64px; height: 64px; margin: 0 auto 24px; opacity: 0.5;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
      </svg>
      <h3 style="font-size: 18px; margin: 0 0 8px 0;">Нет результатов</h3>
      <p style="margin: 0;">Попробуйте изменить поисковый запрос или проверьте правильность написания</p>
    </div>

    <!-- Loading State -->
    <div id="loading-state" style="display: none;">
      <div class="card">
        <div class="card-content" style="padding: 48px; text-align: center;">
          <div style="display: inline-flex; align-items: center; gap: 16px; color: hsl(var(--muted-foreground));">
            <div style="width: 24px; height: 24px; border: 2px solid hsl(var(--muted)); border-top: 2px solid hsl(var(--primary)); border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <span>Поиск компонентов...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Product image styles */
    .product-thumb {
      width: 48px;
      height: 48px;
      border-radius: calc(var(--radius));
      object-fit: cover;
      border: 1px solid hsl(var(--border));
    }

    /* Region badge */
    .region-badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 500;
      background-color: hsl(var(--secondary));
      color: hsl(var(--secondary-foreground));
      border-radius: 999px;
    }

    /* Price display */
    .price-rub {
      color: #16a34a;
      font-weight: 600;
    }

    .price-range {
      font-size: 13px;
      color: hsl(var(--muted-foreground));
    }

    /* Product card for card view */
    .product-card {
      border: 1px solid hsl(var(--border));
      border-radius: calc(var(--radius) + 2px);
      background-color: hsl(var(--card));
      padding: 16px;
      transition: all 0.2s ease;
    }

    .product-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      border-color: hsl(var(--primary));
    }

    /* Active view button */
    .view-btn-active {
      background-color: hsl(var(--primary)) !important;
      color: hsl(var(--primary-foreground)) !important;
    }

    /* Mobile responsive table */
    @media (max-width: 768px) {
      .grid-cols-3 {
        grid-template-columns: 1fr;
      }
      
      .table-head,
      .table-cell {
        padding: 12px 8px;
        font-size: 14px;
      }
      
      .table-head:nth-child(n+5),
      .table-cell:nth-child(n+5) {
        display: none;
      }
    }
  </style>

  <script src="/public/js/dashboard-layout.js"></script>
  <script src="/ui/search-enhanced.js"></script>
  <script>
    class SearchPageController {
      constructor() {
        this.currentView = 'table';
        this.init();
      }

      init() {
        this.bindViewToggle();
        this.initializeFromURL();
      }

      bindViewToggle() {
        const tableBtn = document.getElementById('table-view-btn');
        const cardBtn = document.getElementById('card-view-btn');
        const tableView = document.getElementById('table-view');
        const cardView = document.getElementById('card-view');

        tableBtn.addEventListener('click', () => {
          this.currentView = 'table';
          tableView.style.display = 'block';
          cardView.style.display = 'none';
          tableBtn.classList.add('view-btn-active');
          cardBtn.classList.remove('view-btn-active');
        });

        cardBtn.addEventListener('click', () => {
          this.currentView = 'card';
          tableView.style.display = 'none';
          cardView.style.display = 'block';
          cardBtn.classList.add('view-btn-active');
          tableBtn.classList.remove('view-btn-active');
        });

        // Set initial active state
        tableBtn.classList.add('view-btn-active');
      }

      initializeFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const initialQuery = urlParams.get('q');
        if (initialQuery && typeof window.performSearch === 'function') {
          document.getElementById('search-input').value = initialQuery;
          window.performSearch(initialQuery);
        }
      }

      // Method to render card view (called from search-enhanced.js)
      renderCardView(data) {
        const cardContainer = document.getElementById('results-cards');
        
        if (!data || data.length === 0) {
          cardContainer.innerHTML = '<p style="text-align: center; color: hsl(var(--muted-foreground)); grid-column: span 3; padding: 32px;">Нет результатов</p>';
          return;
        }

        const cardsHtml = data.map(item => {
          const price = item.priceRub ? 
            `<div class="price-rub">₽${item.priceRub}</div>` + 
            (item.priceRange ? `<div class="price-range">${item.priceRange}</div>` : '') :
            '<div style="color: hsl(var(--muted-foreground));">Цена по запросу</div>';

          return `
            <div class="product-card">
              <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                <img src="${item.imageUrl || '/images/no-image.png'}" alt="${item.mpn}" class="product-thumb" onerror="this.src='/images/no-image.png'">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 600; margin-bottom: 2px;">${item.mpn}</div>
                  <div style="font-size: 13px; color: hsl(var(--muted-foreground));">${item.manufacturer}</div>
                </div>
              </div>
              
              <div style="margin-bottom: 12px;">
                <p style="font-size: 14px; color: hsl(var(--foreground)); margin: 0; line-height: 1.4;">${item.description || 'Описание недоступно'}</p>
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <span class="region-badge">${item.region || 'Не указан'}</span>
                <div style="text-align: right;">
                  ${price}
                </div>
              </div>
              
              <a href="${item.productUrl}" target="_blank" class="btn btn-primary btn-sm" style="width: 100%; text-decoration: none; justify-content: center;">
                Перейти к товару
              </a>
            </div>
          `;
        }).join('');

        cardContainer.innerHTML = cardsHtml;
      }
    }

    // Initialize page controller
    window.addEventListener('load', () => {
      window.searchPageController = new SearchPageController();
    });
  </script>
</body>
</html>