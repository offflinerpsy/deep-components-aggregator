<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞—Ç–∞–ª–æ–≥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ ‚Äì Deep Aggregator</title>
  <link rel="stylesheet" href="/styles/main.css">
  <style>
    .catalog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .category-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .category-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
      border-color: #2563eb;
    }
    .category-icon {
      width: 64px;
      height: 64px;
      background: #f3f4f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }
    .category-name {
      font-size: 16px;
      font-weight: 500;
      color: #1f2937;
      line-height: 1.4;
    }
    .breadcrumb {
      padding: 16px 20px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 14px;
    }
    .breadcrumb a {
      color: #2563eb;
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }
    .breadcrumb-separator {
      color: #9ca3af;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 20px;
      text-align: center;
    }
    .header h1 {
      margin: 0;
      font-size: 32px;
      font-weight: 600;
    }
    .header p {
      margin: 12px 0 0;
      opacity: 0.9;
      font-size: 16px;
    }
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 20px;
      margin: 20px;
      border-radius: 8px;
      border: 1px solid #fecaca;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üì¶ –ö–∞—Ç–∞–ª–æ–≥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</h1>
    <p>DigiKey –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî 1193+ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</p>
  </div>

  <nav class="breadcrumb" id="breadcrumb" style="display: none;">
    <a href="/catalog-test">üè† –ì–ª–∞–≤–Ω–∞—è</a>
  </nav>

  <div id="content">
    <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...</div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const categorySlug = urlParams.get('category');

    async function loadCategories() {
      const contentEl = document.getElementById('content');
      const breadcrumbEl = document.getElementById('breadcrumb');

      try {
        let url = '/api/catalog/categories';
        let breadcrumbUrl = null;

        // If category specified ‚Äì load subcategories
        if (categorySlug) {
          url = `/api/catalog/categories/${encodeURIComponent(categorySlug)}`;
          breadcrumbUrl = `/api/catalog/breadcrumb/${encodeURIComponent(categorySlug)}`;
        }

        // Load category data
        const response = await fetch(url);
        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error || 'Failed to load categories');
        }

        // If leaf category ‚Äì show search form instead of redirect
        if (data.category && data.category.is_leaf) {
          renderSearchForm(data.category);
          return;
        }

        // Show breadcrumb if not root
        if (categorySlug && breadcrumbUrl) {
          const breadcrumbResponse = await fetch(breadcrumbUrl);
          const breadcrumbData = await breadcrumbResponse.json();

          if (breadcrumbData.ok && breadcrumbData.breadcrumb) {
            renderBreadcrumb(breadcrumbData.breadcrumb);
            breadcrumbEl.style.display = 'flex';
          }
        }

        // Render categories
        const categories = categorySlug ? data.subcategories : data.categories;
        renderCategories(categories);

      } catch (err) {
        contentEl.innerHTML = `
          <div class="error">
            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}
          </div>
        `;
      }
    }

    function renderBreadcrumb(breadcrumb) {
      const breadcrumbEl = document.getElementById('breadcrumb');
      const html = `
        <a href="/catalog-test">üè† –ì–ª–∞–≤–Ω–∞—è</a>
        ${breadcrumb.map((item, idx) => {
          const isLast = idx === breadcrumb.length - 1;
          const link = isLast 
            ? `<span class="breadcrumb-current">${item.name}</span>`
            : `<a href="/catalog-test?category=${encodeURIComponent(item.slug)}">${item.name}</a>`;
          return `<span class="breadcrumb-separator">‚Ä∫</span>${link}`;
        }).join('')}
      `;
      breadcrumbEl.innerHTML = html;
    }

    function renderCategories(categories) {
      const contentEl = document.getElementById('content');

      if (!categories || categories.length === 0) {
        contentEl.innerHTML = '<div class="loading">–ù–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
        return;
      }

      const html = `
        <div class="catalog-grid">
          ${categories.map(cat => {
            const icon = getIconForCategory(cat.name);
            // Leaf categories open in same page with search form
            const href = cat.is_leaf 
              ? `/catalog-test?category=${encodeURIComponent(cat.slug)}`
              : `/catalog-test?category=${encodeURIComponent(cat.slug)}`;
            
            return `
              <a href="${href}" class="category-card">
                <div class="category-icon">${icon}</div>
                <div class="category-name">${cat.name}</div>
              </a>
            `;
          }).join('')}
        </div>
      `;

      contentEl.innerHTML = html;
    }

    function renderSearchForm(category) {
      const contentEl = document.getElementById('content');
      const breadcrumbEl = document.getElementById('breadcrumb');

      // Show breadcrumb
      breadcrumbEl.style.display = 'flex';
      
      contentEl.innerHTML = `
        <div style="max-width: 800px; margin: 40px auto; padding: 20px;">
          <h2 style="text-align: center; margin-bottom: 30px; color: #1f2937;">
            üîç –ü–æ–∏—Å–∫ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${category.name}
          </h2>
          
          <form action="/results" method="GET" style="display: flex; gap: 12px; margin-bottom: 30px;">
            <input 
              type="text" 
              name="q" 
              placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞..."
              style="flex: 1; padding: 16px 20px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px; outline: none;"
              onfocus="this.style.borderColor='#2563eb'"
              onblur="this.style.borderColor='#e0e0e0'"
              required
            />
            <input type="hidden" name="category" value="${category.path}" />
            <button 
              type="submit"
              style="padding: 16px 32px; font-size: 16px; font-weight: 500; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s;"
              onmouseover="this.style.transform='scale(1.05)'"
              onmouseout="this.style.transform='scale(1)'"
            >
              –ò—Å–∫–∞—Ç—å
            </button>
          </form>

          <div style="background: #f9fafb; padding: 20px; border-radius: 8px; border-left: 4px solid #2563eb;">
            <p style="margin: 0; color: #6b7280; font-size: 14px;">
              üí° <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞, –Ω–æ–º–µ—Ä –º–æ–¥–µ–ª–∏ –∏–ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
            </p>
          </div>
        </div>
      `;
    }

    function getIconForCategory(name) {
      const lower = name.toLowerCase();
      
      if (lower.includes('capacitor')) return 'üîã';
      if (lower.includes('resistor')) return 'üîå';
      if (lower.includes('transistor') || lower.includes('mosfet') || lower.includes('diode')) return '‚ö°';
      if (lower.includes('connector') || lower.includes('cable')) return 'üîó';
      if (lower.includes('integrated circuit') || lower.includes('ic') || lower.includes('processor')) return 'üñ•Ô∏è';
      if (lower.includes('memory')) return 'üíæ';
      if (lower.includes('sensor')) return 'üå°Ô∏è';
      if (lower.includes('led') || lower.includes('light')) return 'üí°';
      if (lower.includes('battery')) return 'üîã';
      if (lower.includes('audio') || lower.includes('speaker')) return 'üîä';
      if (lower.includes('display') || lower.includes('lcd')) return 'üì∫';
      if (lower.includes('switch') || lower.includes('button')) return 'üîò';
      if (lower.includes('relay')) return '‚öôÔ∏è';
      if (lower.includes('crystal') || lower.includes('oscillator')) return '‚è±Ô∏è';
      if (lower.includes('filter')) return 'üéõÔ∏è';
      if (lower.includes('inductor') || lower.includes('coil')) return 'üß≤';
      if (lower.includes('power') || lower.includes('supply')) return '‚ö°';
      if (lower.includes('motor')) return 'üîÑ';
      if (lower.includes('box') || lower.includes('enclosure')) return 'üì¶';
      if (lower.includes('tool')) return 'üîß';
      if (lower.includes('thermal')) return 'üå°Ô∏è';
      
      return 'üìÇ'; // Default folder icon
    }

    // Initialize
    loadCategories();
  </script>
</body>
</html>
