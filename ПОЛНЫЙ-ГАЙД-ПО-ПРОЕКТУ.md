# 🚀 Полный гайд по проекту ProSnab Components Aggregator

## 📋 Содержание

1. [Обзор проекта](#обзор-проекта)
2. [Архитектура системы](#архитектура-системы)
3. [Установка и запуск](#установка-и-запуск)
4. [Админ-панель](#админ-панель)
5. [Управление товарами](#управление-товарами)
6. [Система наценки](#система-наценки)
7. [API и интеграции](#api-и-интеграции)
8. [Мониторинг и логи](#мониторинг-и-логи)
9. [Безопасность](#безопасность)
10. [Поддержка и развитие](#поддержка-и-развитие)

---

## 🎯 Обзор проекта

**ProSnab Components Aggregator** — это агрегатор электронных компонентов, который собирает данные о товарах от различных поставщиков и предоставляет единый интерфейс для поиска и заказа.

### Основные возможности:
- 🔍 **Поиск товаров** по MPN, производителю, описанию
- 🏪 **Множественные поставщики**: Mouser, DigiKey, TME, Farnell
- 💰 **Система наценки** с гибким управлением
- 📦 **Ручные товары** с произвольными полями
- 🛒 **Система заказов** с уведомлениями
- 📊 **Админ-панель** для управления контентом
- 📱 **Адаптивный дизайн** для всех устройств

### Технологический стек:
- **Backend**: Node.js, Express.js, SQLite, Sequelize
- **Frontend**: Next.js, React, Tailwind CSS
- **Admin Panel**: AdminJS
- **Поставщики**: REST API интеграции
- **Деплой**: PM2, Nginx

---

## 🏗️ Архитектура системы

### Компоненты системы:

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend       │    │   Database      │
│   (Next.js)     │◄──►│   (Express)     │◄──►│   (SQLite)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Admin Panel   │    │   API Routes    │    │   Cache Layer   │
│   (AdminJS)     │    │   /api/*        │    │   (In-Memory)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                    ┌─────────────────┐
                    │   Providers     │
                    │   (External)    │
                    └─────────────────┘
```

### Структура проекта:

```
/opt/deep-agg/
├── api/                    # API endpoints
├── src/
│   ├── admin/              # AdminJS configuration
│   ├── db/                 # Database models
│   ├── integrations/       # Provider integrations
│   ├── search/             # Search logic
│   └── utils/              # Utilities
├── v0-components-aggregator-page/  # Frontend
├── nginx/                  # Nginx configuration
├── scripts/                # Utility scripts
└── var/db/                 # Database files
```

---

## 🚀 Установка и запуск

### Предварительные требования:
- Node.js 18+
- PM2
- Nginx
- Git

### Установка:

```bash
# Клонирование репозитория
git clone https://github.com/offflinerpsy/deep-components-aggregator.git
cd deep-components-aggregator

# Установка зависимостей
npm install

# Установка зависимостей фронтенда
cd v0-components-aggregator-page
npm install
cd ..

# Запуск сервисов
pm2 start ecosystem.config.js
pm2 start v0-components-aggregator-page/ecosystem.config.js
```

### Конфигурация:

1. **Переменные окружения** (`.env`):
```env
NEXT_PUBLIC_API_BASE_URL=http://localhost:9201
MOUSER_API_KEY=your_mouser_key
DIGIKEY_CLIENT_ID=your_digikey_id
DIGIKEY_CLIENT_SECRET=your_digikey_secret
TME_TOKEN=your_tme_token
TME_SECRET=your_tme_secret
FARNELL_API_KEY=your_farnell_key
```

2. **Nginx конфигурация** (`nginx/prosnab.tech.conf`):
```nginx
server {
    listen 80;
    server_name prosnab.tech;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/ {
        proxy_pass http://localhost:9201;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /admin/ {
        auth_basic "Admin Area";
        auth_basic_user_file /etc/nginx/.htpasswd;
        proxy_pass http://localhost:9201;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## 🎛️ Админ-панель

### Доступ к админ-панели:

**URL**: `https://prosnab.tech/admin`

**Учетные данные суперадминистратора:**
- **Email**: `admin@prosnab.tech`
- **Пароль**: `password`

⚠️ **Важно**: После первого входа смените пароль на более надежный!

### Структура админ-панели:

#### 1. **Система** (System)
- **Settings** - Системные настройки
- **Api Health** - Мониторинг API поставщиков
- **Api Keys** - Управление ключами API
- **Admin Users** - Пользователи админки

#### 2. **Уведомления** (Notifications)
- **Admin Notifications** - Системные уведомления

#### 3. **Управление** (Management)
- **Orders** - Заказы пользователей

#### 4. **Контент** (Content)
- **Static Pages** - Статические страницы сайта

#### 5. **Товары** (Products)
- **Manual Products** - Ручные товары
- **Manual Product Fields** - Произвольные поля товаров

#### 6. **Статистика** (Statistics)
- **Project Stats** - Статистика проекта

---

## 📦 Управление товарами

### Ручные товары (Manual Products)

Ручные товары позволяют добавлять собственные товары в агрегатор, которые будут отображаться в поиске наравне с товарами поставщиков.

#### Создание товара:

1. **Основные поля**:
   - **MPN** (обязательно) - Номер детали производителя
   - **Manufacturer** (обязательно) - Производитель
   - **Description** - Описание товара
   - **Price** - Цена за единицу
   - **Currency** - Валюта (RUB, USD, EUR, GBP, CNY, JPY)
   - **Region** - Регион поставки
   - **Stock** - Количество на складе
   - **Category** - Категория товара

2. **Расширенные поля**:
   - **Technical Specs** - Технические характеристики (JSON)
   - **Images** - Массив изображений (JSON)
   - **Datasheets** - Массив даташитов (JSON)
   - **Pricing** - Ценовые уровни (JSON)
   - **Availability** - Информация о наличии (JSON)
   - **Regions** - Регионы поставки (JSON)
   - **Package** - Тип корпуса
   - **Packaging** - Тип упаковки
   - **Vendor URL** - Ссылка на страницу поставщика
   - **Source** - Источник товара

#### Произвольные поля (Manual Product Fields):

Для добавления дополнительных характеристик товара:

1. Создайте основной товар в **Manual Products**
2. Запомните его **ID**
3. Откройте **Manual Product Fields**
4. Добавьте поля с **Product ID** = ID товара

**Примеры произвольных полей**:

| Field Name | Field Value | Field Type | Описание |
|------------|-------------|------------|----------|
| Packaging | MouseReel | string | Тип упаковки |
| Standard Pack Qty | 10000 | number | Стандартное количество в упаковке |
| RoHS Status | RoHS Compliant | string | Статус RoHS |
| Lead Time | 77 Days | string | Срок поставки |
| Minimum Order Quantity | 1 | number | Минимальный заказ |
| Order Multiple | 1 | number | Кратность заказа |
| Reeling | Yes | boolean | Намотка |
| USHTS | 8533210030 | string | Код USHTS |
| ECCN | EAR99 | string | Код ECCN |
| Power (Watts) | 0.063W, 1/16W | string | Мощность |
| Composition | Thick Film | string | Состав |
| Features | Automotive AEC-Q200 | string | Особенности |
| Operating Temperature | -55°C ~ 155°C | string | Рабочая температура |
| Package / Case | 0402 (1005 Metric) | string | Корпус |
| Size / Dimension | 0.039" L x 0.020" W | string | Размеры |
| Height - Seated (Max) | 0.016" (0.40mm) | string | Высота |
| Number of Terminations | 2 | number | Количество выводов |
| Manufacturer Lead Weeks | 13 | number | Недели поставки производителя |
| Normally Stocking | Yes | boolean | Обычно в наличии |

### Логика работы товаров:

1. **Поиск**: Товары появляются в результатах поиска по MPN, производителю, описанию
2. **Приоритет**: Ручные товары имеют приоритет над товарами поставщиков
3. **Отображение**: Все поля (основные + произвольные) отображаются в карточке товара
4. **Технические характеристики**: Объединяются основные и произвольные поля
5. **Сортировка**: Товары сортируются по релевантности и цене

---

## 💰 Система наценки

### Управление наценкой:

Система позволяет устанавливать глобальную наценку в процентах на все товары в агрегаторе.

#### Настройка наценки:

1. **Через админку**:
   - Откройте **Settings**
   - Найдите настройку `markup_percentage`
   - Установите нужный процент (например, 20 для 20%)

2. **Через API**:
   ```bash
   # Получить текущую наценку
   curl -X GET http://localhost:9201/api/admin/markup
   
   # Установить наценку 25%
   curl -X POST http://localhost:9201/api/admin/markup \
     -H "Content-Type: application/json" \
     -d '{"markup_percentage": 25}'
   ```

#### Применение наценки:

- **Автоматически**: Наценка применяется ко всем товарам в поиске и карточках
- **Ручные товары**: Наценка применяется к базовой цене
- **Товары поставщиков**: Наценка применяется к ценам от API
- **Ценовые уровни**: Наценка применяется ко всем ценовым уровням

#### Примеры:

| Оригинальная цена | Наценка 20% | Наценка 30% |
|-------------------|-------------|-------------|
| 100.00 руб        | 120.00 руб  | 130.00 руб  |
| 50.00 USD         | 60.00 USD   | 65.00 USD   |
| 25.50 EUR         | 30.60 EUR   | 33.15 EUR   |

---

## 🔌 API и интеграции

### Основные API endpoints:

#### Поиск товаров:
```http
GET /api/search?q={query}
```

**Параметры**:
- `q` - Поисковый запрос (MPN, производитель, описание)

**Ответ**:
```json
{
  "ok": true,
  "q": "TEST-RESISTOR-10K",
  "rows": [
    {
      "mpn": "TEST-RESISTOR-10K",
      "manufacturer": "ProSnab",
      "title": "Тестовый резистор 10 кОм ±1% 0.25W",
      "min_price": 22.32,
      "min_price_rub": 22.32,
      "source": "manual",
      "technical_specs": {...}
    }
  ],
  "meta": {
    "source": "providers",
    "total": 1,
    "elapsed": 1234
  }
}
```

#### Получение товара:
```http
GET /api/product?mpn={mpn}
```

**Параметры**:
- `mpn` - Номер детали производителя

#### Создание заказа:
```http
POST /api/order
```

**Тело запроса**:
```json
{
  "items": [
    {
      "mpn": "TEST-RESISTOR-10K",
      "quantity": 100,
      "price": 22.32
    }
  ],
  "customer": {
    "name": "Иван Иванов",
    "company": "ООО Тест",
    "contact": {
      "email": "ivan@test.com",
      "phone": "+7 (495) 123-45-67"
    }
  }
}
```

### Интеграции с поставщиками:

#### Поддерживаемые поставщики:
- **Mouser** - `https://www.mouser.com`
- **DigiKey** - `https://www.digikey.com`
- **TME** - `https://www.tme.com`
- **Farnell** - `https://www.farnell.com`

#### Настройка API ключей:

1. **Через админку**:
   - Откройте **Api Keys**
   - Обновите ключи для каждого поставщика

2. **Через переменные окружения**:
   ```env
   MOUSER_API_KEY=your_mouser_key
   DIGIKEY_CLIENT_ID=your_digikey_id
   DIGIKEY_CLIENT_SECRET=your_digikey_secret
   TME_TOKEN=your_tme_token
   TME_SECRET=your_tme_secret
   FARNELL_API_KEY=your_farnell_key
   ```

---

## 📊 Мониторинг и логи

### Логи системы:

#### Расположение логов:
- **Backend**: `/opt/deep-agg/logs/`
- **Frontend**: `/opt/deep-agg/v0-components-aggregator-page/logs/`

#### Типы логов:
- `out.log` - Стандартный вывод
- `err.log` - Ошибки
- `combined.log` - Объединенные логи

#### Просмотр логов:
```bash
# Просмотр логов backend
pm2 logs deep-agg

# Просмотр логов frontend
pm2 logs deep-v0

# Просмотр конкретного файла
tail -f /opt/deep-agg/logs/out.log
```

### Мониторинг системы:

#### PM2 статус:
```bash
pm2 status
pm2 monit
```

#### Health checks:
```bash
# Backend health
curl http://localhost:9201/admin/health

# Frontend health
curl http://localhost:3000/api/health
```

#### Метрики:
- **API вызовы**: Количество запросов к поставщикам
- **Время ответа**: Среднее время ответа API
- **Кэш**: Статистика попаданий в кэш
- **Заказы**: Количество и статус заказов

---

## 🔒 Безопасность

### Аутентификация:

#### Админ-панель:
- **Basic Auth** через Nginx
- **Session-based** аутентификация в AdminJS
- **CSRF** защита

#### API:
- **Rate limiting** для предотвращения злоупотреблений
- **Input validation** для всех входящих данных
- **SQL injection** защита через параметризованные запросы

### Конфигурация безопасности:

#### Nginx:
```nginx
# Ограничение размера запроса
client_max_body_size 10M;

# Таймауты
proxy_connect_timeout 30s;
proxy_send_timeout 30s;
proxy_read_timeout 30s;

# Заголовки безопасности
add_header X-Frame-Options DENY;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";
```

#### Express.js:
```javascript
// CORS настройки
app.use(cors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || ['https://prosnab.tech'],
  credentials: true
}));

// Rate limiting
app.use(rateLimit({
  windowMs: 15 * 60 * 1000, // 15 минут
  max: 100 // максимум 100 запросов на IP
}));
```

---

## 🛠️ Поддержка и развитие

### Структура проекта:

#### Основные директории:
- `api/` - API endpoints
- `src/` - Исходный код backend
- `v0-components-aggregator-page/` - Frontend приложение
- `nginx/` - Конфигурация Nginx
- `scripts/` - Утилиты и скрипты
- `var/db/` - База данных SQLite

#### Ключевые файлы:
- `server.js` - Основной сервер
- `ecosystem.config.js` - Конфигурация PM2
- `package.json` - Зависимости проекта
- `ГАЙД-ПО-АДМИНКЕ.md` - Гайд по админке
- `ПОЛНЫЙ-ГАЙД-ПО-ПРОЕКТУ.md` - Этот файл

### Разработка:

#### Добавление нового поставщика:
1. Создайте модуль в `src/integrations/{provider}/`
2. Реализуйте функции поиска и получения товара
3. Добавьте нормализацию данных
4. Интегрируйте в оркестратор поиска

#### Добавление новых полей товара:
1. Обновите модель `ManualProduct` в `src/db/models.js`
2. Добавьте миграцию базы данных
3. Обновите конфигурацию AdminJS
4. Обновите фронтенд компоненты

### Тестирование:

#### Smoke tests:
```bash
# Запуск тестов API
./scripts/admin-api-smoke-tests.sh
```

#### Ручное тестирование:
1. **Поиск товаров**: Проверьте различные запросы
2. **Создание заказов**: Протестируйте процесс заказа
3. **Админ-панель**: Проверьте все разделы
4. **Наценка**: Убедитесь в корректном применении

### Обновления:

#### Обновление системы:
```bash
# Получение обновлений
git pull origin main

# Установка новых зависимостей
npm install

# Перезапуск сервисов
pm2 restart all
```

#### Резервное копирование:
```bash
# Бэкап базы данных
cp var/db/deepagg.sqlite var/db/deepagg.sqlite.backup.$(date +%Y%m%d)

# Бэкап конфигурации
tar -czf config-backup-$(date +%Y%m%d).tar.gz nginx/ ecosystem.config.js
```

---

## 📞 Контакты и поддержка

### Техническая поддержка:
- **Email**: support@prosnab.tech
- **Telegram**: @prosnab_support
- **GitHub**: https://github.com/offflinerpsy/deep-components-aggregator

### Документация:
- **Гайд по админке**: [ГАЙД-ПО-АДМИНКЕ.md](./ГАЙД-ПО-АДМИНКЕ.md)
- **API документация**: [API.md](./API.md)
- **Changelog**: [CHANGELOG.md](./CHANGELOG.md)

### Полезные ссылки:
- **Админ-панель**: https://prosnab.tech/admin
- **API Health**: https://prosnab.tech/admin/health
- **Frontend**: https://prosnab.tech
- **GitHub**: https://github.com/offflinerpsy/deep-components-aggregator

---

## 📝 Changelog

### Версия 1.0.0 (2025-10-17)

#### Новые возможности:
- ✅ Система наценки с глобальным управлением
- ✅ Произвольные поля для ручных товаров
- ✅ Улучшенная админ-панель с подсказками
- ✅ Поддержка множественных валют
- ✅ Приоритет ручных товаров в поиске
- ✅ Интеграция с 4 поставщиками
- ✅ Система заказов с уведомлениями
- ✅ Адаптивный дизайн

#### Исправления:
- ✅ Исправлена страница Settings в админке
- ✅ Исправлен поиск ручных товаров
- ✅ Исправлен выпадающий список валют
- ✅ Улучшена производительность поиска

#### Технические улучшения:
- ✅ Оптимизирована архитектура поиска
- ✅ Добавлена система кэширования
- ✅ Улучшена обработка ошибок
- ✅ Добавлено логирование

---

**Последнее обновление**: 17 октября 2025  
**Версия документации**: 1.0.0  
**Автор**: ProSnab Development Team
